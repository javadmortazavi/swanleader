<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ± - Swan Family</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Backendless SDK -->
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>

  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

  <!-- jalaali-js Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® -->
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.3/dist/jalaali.min.js"></script>

  <!-- Chart.js Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ --brand:#009688; --bg:#f6f7fb; --card:#fff; --txt:#222 }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Tahoma,system-ui,sans-serif}
    header{background:#222;color:#fff;padding:12px 16px}
    header h1{margin:0;font-size:18px}
    .container{max-width:1200px;margin:16px auto;padding:0 12px}

    .filters{display:grid;grid-template-columns:repeat(4, minmax(180px,1fr));gap:12px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
    label{font-weight:700;font-size:.95rem}
    select,input{width:100%;margin-top:6px;padding:.55rem;border:1px solid #e0e0e0;border-radius:10px}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:12px}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .title{color:#666}
    .kpi .val{font-size:22px;font-weight:900}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    canvas{width:100% !important; height:360px !important}

    .section{margin-top:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:right}
    th{background:#fafafa}
    .muted{color:#666;font-size:.9rem}

    .deny{max-width:800px;margin:40px auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06);text-align:center}
    .hidden{display:none}

    @media (max-width:1000px){ .grid2{grid-template-columns:1fr} .kpis{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){ .filters{grid-template-columns:1fr 1fr} .kpis{grid-template-columns:1fr} }
    a.btn{display:inline-block;background:var(--brand);color:#fff;padding:.55rem 1rem;border-radius:10px;text-decoration:none}
  </style>
</head>
<body>
<header>
  <h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ± Swan Family</h1>
</header>

<div class="container">
  <!-- Ø¯Ø³ØªØ±Ø³ÛŒ -->
  <div id="deny" class="deny hidden">
    <h3>ğŸš« Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯</h3>
    <p>Ø§ÛŒÙ† ØµÙØ­Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ± Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø§Ø³Øª.</p>
    <p class="muted">Ø¨Ø§ Ø§Ú©Ø§Ù†Øª Ù…Ø¯ÛŒØ± ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ÛŒØ§ Ø§Ø² Ù„ÛŒÙ†Ú© Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§ <code>?admin=true</code> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>
    <div style="margin-top:8px">
      <a href="assistant.html" class="btn">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ù†Ù„ Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø±</a>
    </div>
  </div>

  <div id="dash" class="hidden">
    <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
    <div class="filters">
      <div>
        <label>Ø§Ø³ØªØ§Ù†</label>
        <select id="fProvince"><option value="">Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</option></select>
      </div>
      <div>
        <label>Ø´Ù‡Ø±</label>
        <select id="fCity"><option value="">Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§</option></select>
      </div>
      <div>
        <label>Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø±</label>
        <select id="fAssistant"><option value="">Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø±Ù‡Ø§</option></select>
      </div>
      <div>
        <label>Ø³Ø§Ù„ (Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡)</label>
        <select id="fYearJ"><option value="">Ø®ÙˆØ¯Ú©Ø§Ø±</option></select>
      </div>
    </div>

    <!-- KPI Ù‡Ø§ -->
    <div class="kpis">
      <div class="card kpi">
        <div class="title">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù†ÛŒÙˆØ¨Ù„Ø§Ø¯</div>
        <div id="kNewbloods" class="val">0</div>
        <div class="muted" id="kFilterHint"></div>
      </div>
      <div class="card kpi">
        <div class="title">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø± ÙØ¹Ø§Ù„</div>
        <div id="kAssistants" class="val">0</div>
      </div>
      <div class="card kpi">
        <div class="title">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù‚Ø³Ø§Ø· Ø§ÛŒÙ† Ø³Ø§Ù„</div>
        <div id="kYearInstallments" class="val">0</div>
        <div class="muted" id="kYearTitle"></div>
      </div>
      <div class="card kpi">
        <div class="title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø·Ø­ Ø±Ø´Ø¯</div>
        <div id="kAvgGrowth" class="val">0</div>
      </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ 1 -->
    <div class="grid2">
      <div class="card">
        <h3 style="margin-top:0">ØªØ¹Ø¯Ø§Ø¯ Ù†ÛŒÙˆØ¨Ù„Ø§Ø¯ Ù‡Ø± Ù…Ø±Ø¨ÛŒ</h3>
        <canvas id="byAssistantChart"></canvas>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø³Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)</h3>
        <canvas id="installmentsMonthlyChart"></canvas>
      </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ 2 -->
    <div class="grid2">
      <div class="card">
        <h3 style="margin-top:0">Ø¯Ø±ØµØ¯ Ø³Ø·Ø­ Ø±Ø´Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø±Ø¨ÛŒ</h3>
        <canvas id="growthByAssistantChart"></canvas>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Ø¯Ø±ØµØ¯ Ø³Ø·Ø­ Ø±Ø´Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ§Ù†</h3>
        <canvas id="growthByProvinceChart"></canvas>
      </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ -->
    <div class="card section">
      <h3 style="margin-top:0">ØªÙˆØ²ÛŒØ¹ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h3>
      <canvas id="interestsChart"></canvas>
      <div class="muted">ÙÙ‚Ø· Ø³Ù‡ ØªÛŒÚ©: Ø¢Ù†Ø§ØªÙˆÙ…ÛŒØŒ Ø¢ÛŒÙˆØ±ÙˆØ¯Ø§ØŒ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ.</div>
    </div>

    <!-- ØªÙˆÙ„Ø¯Ù‡Ø§ -->
    <div class="card section">
      <h3 style="margin-top:0">ØªÙˆÙ„Ø¯Ù‡Ø§ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù…Ø§Ù‡</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label>Ù…Ø§Ù‡:</label>
        <select id="birthMonthSel"></select>
        <span class="muted">Ù†Ù…Ø§ÛŒØ´ Ø§Ø³Ø§Ù…ÛŒ Ùˆ ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ø´Ù…Ø³ÛŒ)</span>
      </div>
      <div id="birthList" style="margin-top:10px"></div>
    </div>

    <!-- Ø³ÙˆØ§Ù†â€ŒÚ©ÙˆÛŒÙ† Ùˆ Ø¬Ø¯Ø§ÙˆÙ„ -->
    <div class="grid2 section">
      <div class="card">
        <h3 style="margin-top:0">ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù†â€ŒÚ©ÙˆÛŒÙ† Ù‡Ø± Ù†ÙØ±</h3>
        <table id="coinsTable">
          <thead>
            <tr><th>Ù†Ø§Ù…</th><th>ØªØ¹Ø¯Ø§Ø¯ Ú©ÙˆÛŒÙ†</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù‚Ø³Ø§Ø· Ù‡Ø± Ù…Ø§Ù‡ (ØªÙÚ©ÛŒÚ©ÛŒ)</h3>
        <table id="instTable">
          <thead>
            <tr><th>Ù…Ø§Ù‡ (Ø´Ù…Ø³ÛŒ)</th><th>Ø¬Ù…Ø¹ Ø§Ù‚Ø³Ø§Ø· (ØªÙˆÙ…Ø§Ù†)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="section" style="text-align:center;margin:16px 0">
      <a class="btn" href="assistant.html">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ù†Ù„ Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø±</a>
    </div>
  </div>
</div>

<script>
  // ====== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ Ú©Ù…Ú©â€ŒØªØ§Ø¨Ø¹â€ŒÙ‡Ø§ ======
  const ADMIN_NAME  = "Ø¬ÙˆØ§Ø¯ Ù…Ø±ØªØ¶ÙˆÛŒ";
  const ADMIN_EMAIL = "j.mortazavi7@gmail.com";

  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  const jalaliMonthNames = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†","Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª","Ø®Ø±Ø¯Ø§Ø¯","ØªÛŒØ±","Ù…Ø±Ø¯Ø§Ø¯","Ø´Ù‡Ø±ÛŒÙˆØ±","Ù…Ù‡Ø±","Ø¢Ø¨Ø§Ù†","Ø¢Ø°Ø±","Ø¯ÛŒ","Ø¨Ù‡Ù…Ù†","Ø§Ø³ÙÙ†Ø¯"];

  function toDate(x){
    if(!x) return null;
    try{
      if(x instanceof Date) return x;
      if(typeof x === 'number') return new Date(x);
      const d = new Date(x);
      return isNaN(d) ? null : d;
    }catch{ return null; }
  }

  function toJalaliStr(d){
    if(!d) return "";
    d = toDate(d);
    const g = { gy: d.getFullYear(), gm: d.getMonth()+1, gd: d.getDate() };
    const j = jalaali.toJalaali(g.gy, g.gm, g.gd);
    const mm = String(j.jm).padStart(2,'0');
    const dd = String(j.jd).padStart(2,'0');
    return `${j.jy}/${mm}/${dd}`;
  }

  function jalaliYear(d){
    if(!d) return null;
    d = toDate(d);
    const g = { gy: d.getFullYear(), gm: d.getMonth()+1, gd: d.getDate() };
    return jalaali.toJalaali(g.gy,g.gm,g.gd).jy;
  }
  function jalaliMonth(d){
    if(!d) return null;
    d = toDate(d);
    const g = { gy: d.getFullYear(), gm: d.getMonth()+1, gd: d.getDate() };
    return jalaali.toJalaali(g.gy,g.gm,g.gd).jm; // 1..12
  }

  const fmtNum = n => (n||0).toLocaleString('fa-IR');

  // ====== Ø¯Ø³ØªØ±Ø³ÛŒ ======
  (async function initAccess(){
    let allow = false;
    try{
      const u = await Backendless.UserService.getCurrentUser();
      if(u && ((u.name||"")===ADMIN_NAME || (u.email||"")===ADMIN_EMAIL)) allow = true;
    }catch(e){}
    const qs = new URLSearchParams(location.search);
    if(qs.get('admin') === 'true') allow = true;
    const aFrom = qs.get('assistant');
    if(aFrom && decodeURIComponent(aFrom).replace(/_/g,' ').trim() === ADMIN_NAME) allow = true;

    if(!allow){
      document.getElementById('deny').classList.remove('hidden');
      return;
    }
    document.getElementById('dash').classList.remove('hidden');
    await loadAndRender();
  })();

  // ====== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÛŒØªØ§ ======
  let rawData = [];
  async function fetchAllNewbloods(){
    const out = [];
    let page = 0, pageSize = 100, chunk = [];
    const tb = Backendless.Data.of('Newbloods');
    do{
      const qb = Backendless.DataQueryBuilder.create()
                    .setPageSize(pageSize).setOffset(page*pageSize)
                    .setSortBy(['created DESC']);
      chunk = await tb.find(qb);
      out.push(...chunk);
      page++;
    }while(chunk.length === pageSize);
    return out;
  }

  // ====== ÙÛŒÙ„ØªØ±Ù‡Ø§ ======
  function unique(arr){ return [...new Set(arr.filter(Boolean))]; }

  function applyFilters(){
    const p = $('#fProvince').val() || '';
    const c = $('#fCity').val() || '';
    const a = $('#fAssistant').val() || '';
    return rawData.filter(r =>
      (p ? (r.province||'')===p : true) &&
      (c ? (r.city||'')===c : true) &&
      (a ? (r.assistant||'')===a : true)
    );
  }

  function populateFilters(data){
    // Ø§Ø³ØªØ§Ù†/Ø´Ù‡Ø±/Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø±
    const provinces = unique(data.map(r=>r.province||'')).sort();
    const assistants= unique(data.map(r=>r.assistant||'')).sort();
    $('#fProvince').html('<option value="">Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§</option>' + provinces.map(x=>`<option value="${x}">${x}</option>`).join(''));
    $('#fAssistant').html('<option value="">Ù‡Ù…Ù‡ Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø±Ù‡Ø§</option>' + assistants.map(x=>`<option value="${x}">${x}</option>`).join(''));

    // Ø´Ù‡Ø±Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†
    function refreshCities(){
      const p = $('#fProvince').val() || '';
      const cities = unique(data.filter(r=> p? (r.province||'')===p : true).map(r=>r.city||'')).sort();
      $('#fCity').html('<option value="">Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§</option>' + cities.map(x=>`<option value="${x}">${x}</option>`).join(''));
    }
    refreshCities();
    $('#fProvince').on('change', ()=>{ refreshCities(); renderAll(); });
    $('#fCity').on('change', renderAll);
    $('#fAssistant').on('change', renderAll);

    // Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ (Ø´Ù…Ø³ÛŒ) Ø§Ø² ØªØ§Ø±ÛŒØ® Ø§Ù‚Ø³Ø§Ø· Ùˆ ØªÙˆÙ„Ø¯ Ùˆ Ø¯ÙˆØ±Ù‡
    const years = unique(
      data.flatMap(r=>{
        const arr = [];
        if(r.birthdate)   arr.push(jalaliYear(r.birthdate));
        if(r.course_date) arr.push(jalaliYear(r.course_date));
        if(Array.isArray(r.instalments)){
          r.instalments.forEach(i=> i?.date && arr.push(jalaliYear(i.date)));
        }
        return arr;
      })
    ).filter(Boolean).sort((a,b)=>a-b);
    $('#fYearJ').html('<option value="">Ø®ÙˆØ¯Ú©Ø§Ø±</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join(''))
                .on('change', renderAll);

    // Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„Ø¯
    $('#birthMonthSel').html(Array.from({length:12},(_,i)=>`<option value="${i+1}">${jalaliMonthNames[i]}</option>`).join(''))
                       .on('change', renderBirthdays);
  }

  // ====== Ø±Ù†Ø¯Ø± Ú©Ù„ÛŒ ======
  let chByAssistant, chInstMonthly, chGrowthAsst, chGrowthProv, chInterests;

  function destroyChart(ch){ if(ch){ ch.destroy(); } }

  function renderAll(){
    const data = applyFilters();
    // KPI Ù‡Ø§
    $('#kNewbloods').text(fmtNum(data.length));
    const assistants = unique(data.map(r=>r.assistant||'')).length;
    $('#kAssistants').text(fmtNum(assistants));
    const avgGrowth = data.length ? (data.reduce((s,r)=>s + (+r.growth||0),0)/data.length) : 0;
    $('#kAvgGrowth').text((avgGrowth||0).toFixed(1));

    // Ø³Ø§Ù„ KPI Ø§Ù‚Ø³Ø§Ø·
    let yearSel = +($('#fYearJ').val()||0);
    if(!yearSel){
      // Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¯Ú©Ø§Ø±: Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø³Ø§Ù„ Ø¯ÛŒØ¯Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± Ø§Ù‚Ø³Ø§Ø· ÛŒØ§ ØªØ§Ø±ÛŒØ® Ø¯ÙˆØ±Ù‡
      const yrs = unique(
        data.flatMap(r=>{
          const arr=[];
          if(r.course_date) arr.push(jalaliYear(r.course_date));
          if(Array.isArray(r.instalments)) r.instalments.forEach(i=> i?.date && arr.push(jalaliYear(i.date)));
          return arr;
        })
      ).filter(Boolean).sort((a,b)=>b-a);
      yearSel = yrs[0] || jalaliYear(new Date());
      $('#fYearJ').val(yearSel);
    }
    $('#kYearTitle').text(`Ø³Ø§Ù„ ${yearSel}`);

    // Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ¹Ø¯Ø§Ø¯ Ù†ÛŒÙˆØ¨Ù„Ø§Ø¯ Ù‡Ø± Ù…Ø±Ø¨ÛŒ
    const byAsstMap = new Map();
    data.forEach(r=>{
      const a = r.assistant || 'Ù†Ø§Ù…Ø´Ø®Øµ';
      byAsstMap.set(a, (byAsstMap.get(a)||0)+1);
    });
    const asstLabels = [...byAsstMap.keys()];
    const asstVals   = [...byAsstMap.values()];
    destroyChart(chByAssistant);
    chByAssistant = new Chart(document.getElementById('byAssistantChart'), {
      type:'bar',
      data:{ labels: asstLabels, datasets:[{ label:'ØªØ¹Ø¯Ø§Ø¯ Ù†ÛŒÙˆØ¨Ù„Ø§Ø¯', data: asstVals }] },
      options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });

    // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø³Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
    const instByMonth = Array(12).fill(0);
    data.forEach(r=>{
      if(Array.isArray(r.instalments)){
        r.instalments.forEach(it=>{
          const d = toDate(it?.date);
          const amt = +it?.amount || 0;
          if(!d || !amt) return;
          const y = jalaliYear(d);
          const m = jalaliMonth(d);
          if(y === yearSel && m>=1 && m<=12) instByMonth[m-1] += amt;
        });
      }
    });
    destroyChart(chInstMonthly);
    chInstMonthly = new Chart(document.getElementById('installmentsMonthlyChart'), {
      type:'bar',
      data:{ labels: jalaliMonthNames, datasets:[{ label:`Ø¬Ù…Ø¹ Ø§Ù‚Ø³Ø§Ø· Ø³Ø§Ù„ ${yearSel}`, data: instByMonth }] },
      options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
    // KPI Ø¬Ù…Ø¹ Ø³Ø§Ù„
    $('#kYearInstallments').text(fmtNum(instByMonth.reduce((a,b)=>a+b,0)));

    // Ø¯Ø±ØµØ¯ Ø³Ø·Ø­ Ø±Ø´Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø±Ø¨ÛŒ (Stacked)
    const assts = unique(data.map(r=>r.assistant||'Ù†Ø§Ù…Ø´Ø®Øµ'));
    const levels = [1,2,3,4,5];
    const countsAsstLevel = levels.map(lvl =>
      assts.map(a => data.filter(r => (r.assistant||'Ù†Ø§Ù…Ø´Ø®Øµ')===a && (+r.growth||0)===lvl).length)
    );
    const totalsByAsst = assts.map(a => data.filter(r => (r.assistant||'Ù†Ø§Ù…Ø´Ø®Øµ')===a).length || 1);
    const percAsstLevel = countsAsstLevel.map(row => row.map((v,i)=> Math.round( (v*100)/totalsByAsst[i] )));
    destroyChart(chGrowthAsst);
    chGrowthAsst = new Chart(document.getElementById('growthByAssistantChart'), {
      type:'bar',
      data:{
        labels: assts,
        datasets: levels.map((lvl, idx)=>({ label:`Ø³Ø·Ø­ ${lvl}`, data: percAsstLevel[idx], stack:'s' }))
      },
      options:{ responsive:true, scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true, max:100} } }
    });

    // Ø¯Ø±ØµØ¯ Ø³Ø·Ø­ Ø±Ø´Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ§Ù† (Stacked)
    const provs = unique(data.map(r=>r.province||'Ù†Ø§Ù…Ø´Ø®Øµ'));
    const countsProvLevel = levels.map(lvl =>
      provs.map(p => data.filter(r => (r.province||'Ù†Ø§Ù…Ø´Ø®Øµ')===p && (+r.growth||0)===lvl).length)
    );
    const totalsByProv = provs.map(p => data.filter(r => (r.province||'Ù†Ø§Ù…Ø´Ø®Øµ')===p).length || 1);
    const percProvLevel = countsProvLevel.map(row => row.map((v,i)=> Math.round( (v*100)/totalsByProv[i] )));
    destroyChart(chGrowthProv);
    chGrowthProv = new Chart(document.getElementById('growthByProvinceChart'), {
      type:'bar',
      data:{
        labels: provs,
        datasets: levels.map((lvl, idx)=>({ label:`Ø³Ø·Ø­ ${lvl}`, data: percProvLevel[idx], stack:'s' }))
      },
      options:{ responsive:true, scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true, max:100} } }
    });

    // Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ (Ø³Ù‡ ØªÛŒÚ©)
    const interestKeys = ['anatomy','ayurveda','marketing'];
    const interestLabels= ['Ø¢Ù†Ø§ØªÙˆÙ…ÛŒ','Ø¢ÛŒÙˆØ±ÙˆØ¯Ø§','Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ'];
    const interestCounts = [0,0,0];
    data.forEach(r=>{
      const arr = Array.isArray(r.interests)? r.interests : [];
      arr.forEach(k=>{
        const idx = interestKeys.indexOf(k);
        if(idx>=0) interestCounts[idx] += 1;
      });
    });
    destroyChart(chInterests);
    chInterests = new Chart(document.getElementById('interestsChart'), {
      type:'bar',
      data:{ labels: interestLabels, datasets:[{ label:'ØªØ¹Ø¯Ø§Ø¯', data: interestCounts }] },
      options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });

    // Ø¬Ø¯ÙˆÙ„ Ú©ÙˆÛŒÙ†â€ŒÙ‡Ø§ (Ù†Ø§Ù… + ØªØ¹Ø¯Ø§Ø¯)
    const coinsRows = data.map(r=>{
      const n = r.name || 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…';
      const cnt = Array.isArray(r.coins) ? r.coins.length : 0;
      return { name:n, count:cnt };
    }).sort((a,b)=> b.count - a.count);
    const coinsTbody = $('#coinsTable tbody').empty();
    coinsRows.forEach(row=>{
      coinsTbody.append(`<tr><td>${row.name}</td><td>${fmtNum(row.count)}</td></tr>`);
    });

    // Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø´Ù…Ø³ÛŒ)
    const tableMap = new Map(); // key: m(1..12) -> sum
    instByMonth.forEach((v,i)=> tableMap.set(i+1, v));
    const instTbody = $('#instTable tbody').empty();
    [...tableMap.entries()].forEach(([m,sum])=>{
      if(sum>0) instTbody.append(`<tr><td>${jalaliMonthNames[m-1]}</td><td>${fmtNum(sum)}</td></tr>`);
    });

    // Ù„ÛŒØ³Øª ØªÙˆÙ„Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
    renderBirthdays();
    // Ù†Ú©ØªÙ‡â€ŒÛŒ ÙÛŒÙ„ØªØ± Ø¯Ø± KPI
    const hint = [];
    if($('#fProvince').val()) hint.push('Ø§Ø³ØªØ§Ù†: '+$('#fProvince').val());
    if($('#fCity').val())     hint.push('Ø´Ù‡Ø±: '+$('#fCity').val());
    if($('#fAssistant').val())hint.push('Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø±: '+$('#fAssistant').val());
    $('#kFilterHint').text(hint.join(' | '));
  }

  function renderBirthdays(){
    const month = +$('#birthMonthSel').val() || 1;
    const data = applyFilters();
    const list = data
      .filter(r => r.birthdate && jalaliMonth(r.birthdate)===month)
      .map(r => ({ name: r.name||'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…', d: toDate(r.birthdate) }))
      .sort((a,b)=> (a.d?.getDate()||0) - (b.d?.getDate()||0));
    const box = $('#birthList').empty();
    if(!list.length){ box.html('<div class="muted">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>'); return; }
    const rows = list.map(item=>{
      const jstr = toJalaliStr(item.d);
      return `<div>- ${item.name} <span class="muted">(${jstr})</span></div>`;
    }).join('');
    box.html(rows);
  }

  // ====== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø±Ù†Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ‡ ======
  async function loadAndRender(){
    try{
      rawData = await fetchAllNewbloods();
      populateFilters(rawData);
      renderAll();
    }catch(e){
      console.error(e);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§');
    }
  }
</script>
</body>
</html>
