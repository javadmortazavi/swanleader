<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Swan Leader Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <style>
    body{font-family:Tahoma,system-ui,sans-serif;background:#f4f4f4;margin:0}
    #login, .container{max-width:1100px;margin:2rem auto;background:#fff;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:1.5rem}
    #login{max-width:360px;margin-top:10vh}
    input[type=password],button,select{width:100%;padding:.75rem;border-radius:10px;border:1px solid #dedede}
    button{border:none;background:#009688;color:#fff;cursor:pointer}
    h2,h3{margin:.5rem 0 1rem}
    canvas{margin-top:1.25rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem .5rem;border-bottom:1px solid #eee;text-align:right}
    th{background:#fafafa}
    .muted{color:#666;font-size:.92rem}
    .filters{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin:1rem 0}
  </style>
</head>
<body>

<!-- ورود ساده مدیر -->
<div id="login">
  <h3>ورود مدیر Swan Leader</h3>
  <p class="muted">رمز پیش‌فرض: <code>swanadmin</code></p>
  <input type="password" id="adminPass" placeholder="رمز عبور">
  <button onclick="checkLogin()" style="margin-top:.75rem">ورود</button>
</div>

<div class="container" id="dashboard" style="display:none">
  <h2>داشبورد آماری Swan Family</h2>

  <!-- فیلتر ساده بر اساس استان/استادیار -->
  <div class="filters">
    <select id="filterProvince">
      <option value="">فیلتر استان: همه</option>
    </select>
    <select id="filterAssistant">
      <option value="">فیلتر استادیار: همه</option>
    </select>
  </div>

  <div class="grid">
    <div><canvas id="chartProvince"></canvas></div>
    <div><canvas id="chartBirths"></canvas></div>
    <div><canvas id="chartInterests"></canvas></div>
    <div><canvas id="chartCoins"></canvas></div>
    <div><canvas id="chartInstallments"></canvas></div>
    <div><canvas id="chartGrowth"></canvas></div>
    <div style="grid-column:1 / -1"><canvas id="chartAssistant"></canvas></div>
  </div>

  <h3 style="margin-top:2rem">جدول اقساط و فیش‌های پرداختی</h3>
  <p class="muted">روی «مشاهده فیش» کلیک کنید تا تصویر/فایل رسید در پنجره جدید باز شود.</p>
  <div style="overflow:auto">
    <table id="instTable">
      <thead>
        <tr>
          <th>نام</th>
          <th>استان</th>
          <th>استادیار</th>
          <th>تاریخ قسط</th>
          <th>مبلغ (تومان)</th>
          <th>فیش</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // تنظیمات اتصال
  const ADMIN_PASSWORD = "swanadmin";
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  // وضعیت دیتا و نمودارها برای رفرش با فیلترها
  let RAW = [];
  let charts = {};

  function checkLogin(){
    const pass = document.getElementById('adminPass').value.trim();
    if(pass === ADMIN_PASSWORD){
      document.getElementById('login').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadData();
      document.getElementById('filterProvince').addEventListener('change', renderAll);
      document.getElementById('filterAssistant').addEventListener('change', renderAll);
    }else{
      alert("رمز عبور اشتباه است.");
    }
  }

  // ابزار رسم چارت
  function drawChart(id, title, labels, values){
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: title, data: values }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false }, title: { display: true, text: title } },
        scales: { x: { ticks: { autoSkip: true, maxRotation: 0 } } }
      }
    });
  }

  async function loadData(){
    RAW = await Backendless.Data.of("Newbloods").find();
    // پر کردن گزینه‌های فیلتر
    fillFilter('filterProvince', unique(RAW.map(d => d.province).filter(Boolean)));
    fillFilter('filterAssistant', unique(RAW.map(d => d.assistant).filter(Boolean)));
    renderAll();
  }

  function fillFilter(selectId, items){
    const sel = document.getElementById(selectId);
    sel.innerHTML = `<option value="">همه</option>` + items.map(v=>`<option>${escapeHtml(v)}</option>`).join('');
  }

  function escapeHtml(s){ return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function unique(arr){ return [...new Set(arr)]; }

  function applyFilters(list){
    const fp = document.getElementById('filterProvince').value;
    const fa = document.getElementById('filterAssistant').value;
    return list.filter(d => (!fp || d.province===fp) && (!fa || d.assistant===fa));
  }

  function renderAll(){
    const data = applyFilters(RAW);

    // 1) استان
    const provinces = {};
    data.forEach(d => {
      const p = d.province || "نامشخص";
      provinces[p] = (provinces[p] || 0) + 1;
    });
    drawChart('chartProvince', 'تعداد نیوبلادها بر اساس استان', Object.keys(provinces), Object.values(provinces));

    // 2) تولدها
    const births = Array(12).fill(0);
    data.forEach(d => {
      if(d.birthdate){
        const m = new Date(d.birthdate).getMonth();
        births[m]++;
      }
    });
    drawChart('chartBirths', 'تولدها در ماه‌های سال', [...Array(12).keys()].map(i => `ماه ${i+1}`), births);

    // 3) علاقه‌مندی‌ها
    const interestsMap = { marketing: 0, anatomy: 0, eastern_medicine: 0, ayurveda: 0 };
    data.forEach(d => {
      const i = d.interests;
      if(Array.isArray(i)) i.forEach(v => (v in interestsMap) && interestsMap[v]++);
      else if(typeof i === 'string' && (i in interestsMap)) interestsMap[i]++;
    });
    drawChart('chartInterests', 'تعداد علاقه‌مندان', Object.keys(interestsMap), Object.values(interestsMap));

    // 4) سوان‌کوین هر نفر
    const coinsPerPerson = {};
    data.forEach(d => {
      const name = d.name || "بی‌نام";
      const log = Array.isArray(d.coins) ? d.coins : [];
      coinsPerPerson[name] = log.length;
    });
    drawChart('chartCoins', 'سوان‌کوین هر نفر', Object.keys(coinsPerPerson), Object.values(coinsPerPerson));

    // 5) اقساط ماهانه و جدول
    const monthlyInstallments = Array(12).fill(0);
    const instRows = [];
    data.forEach(d => {
      const inst = Array.isArray(d.installments) ? d.installments : [];
      inst.forEach(item => {
        if(!item || !item.date) return;
        const dt = new Date(item.date);
        const month = dt.getMonth();
        const amt = Number(item.amount || 0);
        monthlyInstallments[month] += isNaN(amt) ? 0 : amt;
        instRows.push({
          name: d.name || 'بی‌نام',
          province: d.province || 'نامشخص',
          assistant: d.assistant || 'نامشخص',
          date: dt,
          amount: amt,
          receipt_url: item.receipt_url || null
        });
      });
    });
    drawChart('chartInstallments', 'جمع اقساط در ماه', [...Array(12).keys()].map(i => `ماه ${i+1}`), monthlyInstallments);
    buildReceiptsTable(instRows);

    // 6) میانگین رشد بر اساس استان
    const growthByProvince = {};
    data.forEach(d => {
      const g = Number(d.growth || 0);
      const p = d.province || 'نامشخص';
      if(!growthByProvince[p]) growthByProvince[p] = [];
      growthByProvince[p].push(g);
    });
    const avgGrowth = {};
    for(const p in growthByProvince){
      const arr = growthByProvince[p];
      avgGrowth[p] = arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : 0;
    }
    drawChart('chartGrowth', 'میانگین سطح رشد بر اساس استان', Object.keys(avgGrowth), Object.values(avgGrowth));

    // 7) تعداد نیوبلاد بر اساس استادیار
    const assistants = {};
    data.forEach(d => {
      const a = d.assistant || 'نامشخص';
      assistants[a] = (assistants[a] || 0) + 1;
    });
    drawChart('chartAssistant', 'تعداد نیوبلادها بر اساس استادیار', Object.keys(assistants), Object.values(assistants));
  }

  function buildReceiptsTable(rows){
    rows.sort((a,b) => b.date - a.date); // جدیدترین‌ها بالا
    const tbody = document.querySelector('#instTable tbody');
    tbody.innerHTML = '';
    const fdate = d => new Intl.DateTimeFormat('fa-IR').format(d);

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.name)}</td>
        <td>${escapeHtml(r.province)}</td>
        <td>${escapeHtml(r.assistant)}</td>
        <td>${fdate(r.date)}</td>
        <td>${r.amount ? r.amount.toLocaleString('fa-IR') : '-'}</td>
        <td>${r.receipt_url ? `<a href="${r.receipt_url}" target="_blank" rel="noopener">مشاهده فیش</a>` : '-'}</td>
      `;
      tbody.appendChild(tr);
    });
  }
</script>
</body>
</html>
