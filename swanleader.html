<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Swan Leader Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <style>
    body{font-family:Tahoma,system-ui,sans-serif;background:#f4f4f4;margin:0}
    #login,.container{max-width:1100px;margin:2rem auto;background:#fff;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:1.25rem}
    #login{max-width:360px;margin-top:10vh}
    input[type=password],select,button{width:100%;padding:.75rem;border-radius:10px;border:1px solid #dedede}
    button{border:none;background:#009688;color:#fff;cursor:pointer}
    h2,h3{margin:.5rem 0 1rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    canvas{margin-top:1rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:right}
    th{background:#fafafa}
    .filters{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin:1rem 0}
    .muted{color:#666;font-size:.92rem}
  </style>
</head>
<body>

<div id="login">
  <h3>ورود مدیر Swan Leader</h3>
  <p class="muted">رمز پیش‌فرض: <code>swanadmin</code> (بعداً می‌تونیم احراز هویت واقعی بگذاریم)</p>
  <input id="adminPass" type="password" placeholder="رمز عبور">
  <button style="margin-top:.75rem" onclick="checkLogin()">ورود</button>
</div>

<div id="dashboard" class="container" style="display:none">
  <h2>داشبورد آماری Swan Family</h2>

  <div class="filters">
    <select id="filterProvince"><option value="">فیلتر استان: همه</option></select>
    <select id="filterAssistant"><option value="">فیلتر استادیار: همه</option></select>
  </div>

  <div class="grid">
    <div><canvas id="chartProvince"></canvas></div>
    <div><canvas id="chartBirths"></canvas></div>
    <div><canvas id="chartInterests"></canvas></div>
    <div><canvas id="chartCoins"></canvas></div>
    <div><canvas id="chartInstallments"></canvas></div>
    <div><canvas id="chartGrowth"></canvas></div>
    <div style="grid-column:1 / -1"><canvas id="chartAssistant"></canvas></div>
  </div>

  <h3 style="margin-top:2rem">جدول اقساط و فیش‌های پرداختی</h3>
  <p class="muted">روی «مشاهده فیش» کلیک کنید تا تصویر/فایل رسید باز شود.</p>
  <div style="overflow:auto">
    <table id="instTable">
      <thead>
        <tr>
          <th>نام</th>
          <th>استان</th>
          <th>استادیار</th>
          <th>تاریخ قسط</th>
          <th>مبلغ (تومان)</th>
          <th>فیش</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // ---- پیکربندی اتصال
  const ADMIN_PASSWORD = "swanadmin";
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  let RAW = [];
  const charts = {};
  function checkLogin(){
    const p = document.getElementById('adminPass').value.trim();
    if(p === ADMIN_PASSWORD){
      document.getElementById('login').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadData();
      document.getElementById('filterProvince').addEventListener('change', renderAll);
      document.getElementById('filterAssistant').addEventListener('change', renderAll);
    }else{
      alert('رمز عبور اشتباه است');
    }
  }

  // ---- ابزار چارت
  function drawChart(id, title, labels, values){
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: title, data: values }] },
      options: {
        responsive:true,
        plugins:{ legend:{display:false}, title:{display:true,text:title} },
        scales:{ x:{ ticks:{autoSkip:true,maxRotation:0} } }
      }
    });
  }

  async function loadData(){
    RAW = await Backendless.Data.of("Newbloods").find();
    // پر کردن فیلترها
    fillFilter('filterProvince', uniq(RAW.map(d=>d.province).filter(Boolean)));
    fillFilter('filterAssistant', uniq(RAW.map(d=>d.assistant).filter(Boolean)));
    renderAll();
  }

  function fillFilter(id, items){
    const el = document.getElementById(id);
    el.innerHTML = `<option value="">همه</option>` + items.map(x=>`<option>${esc(x)}</option>`).join('');
  }
  function uniq(a){ return [...new Set(a)]; }
  function esc(s){ return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  function applyFilters(list){
    const fp = document.getElementById('filterProvince').value;
    const fa = document.getElementById('filterAssistant').value;
    return list.filter(d => (!fp || d.province===fp) && (!fa || d.assistant===fa));
  }

  function renderAll(){
    const data = applyFilters(RAW);

    // 1) تعداد نیوبلاد بر اساس استان
    const provinces = {};
    data.forEach(d => {
      const p = d.province || "نامشخص";
      provinces[p] = (provinces[p] || 0) + 1;
    });
    drawChart('chartProvince','تعداد نیوبلادها بر اساس استان', Object.keys(provinces), Object.values(provinces));

    // 2) تولدها در ماه‌های سال
    const births = Array(12).fill(0);
    data.forEach(d=>{
      if(d.birthdate){
        const m = new Date(d.birthdate).getMonth();
        births[m]++;
      }
    });
    drawChart('chartBirths','تولدها در ماه‌های سال', [...Array(12).keys()].map(i=>`ماه ${i+1}`), births);

    // 3) علاقه‌مندی‌ها (marketing, anatomy, eastern_medicine, ayurveda)
    const interestMap = { marketing:0, anatomy:0, eastern_medicine:0, ayurveda:0 };
    data.forEach(d=>{
      const arr = Array.isArray(d.interests) ? d.interests : [];
      arr.forEach(k => (k in interestMap) && (interestMap[k]++));
    });
    drawChart('chartInterests','تعداد علاقه‌مندان', Object.keys(interestMap), Object.values(interestMap));

    // 4) سوان‌کوین هر نفر (طول آرایه coins)
    const coinsCount = {};
    data.forEach(d=>{
      const name = d.name || 'بی‌نام';
      const coins = Array.isArray(d.coins) ? d.coins : [];
      coinsCount[name] = coins.length;
    });
    drawChart('chartCoins','سوان‌کوین هر نفر', Object.keys(coinsCount), Object.values(coinsCount));

    // 5) جمع اقساط در هر ماه + جدول فیش‌ها (از instalments)
    const monthly = Array(12).fill(0);
    const rows = [];
    data.forEach(d=>{
      const inst = Array.isArray(d.instalments) ? d.instalments : [];
      inst.forEach(it=>{
        if(!it || !it.date) return;
        const dt = new Date(it.date);
        const m = dt.getMonth();
        const amt = Number(it.amount||0);
        monthly[m] += isNaN(amt) ? 0 : amt;
        rows.push({
          name: d.name || 'بی‌نام',
          province: d.province || 'نامشخص',
          assistant: d.assistant || 'نامشخص',
          date: dt,
          amount: amt,
          receipt_url: it.receipt_url || null
        });
      });
    });
    drawChart('chartInstallments','جمع اقساط در ماه', [...Array(12).keys()].map(i=>`ماه ${i+1}`), monthly);
    buildReceiptsTable(rows);

    // 6) میانگین سطح رشد بر اساس استان (growth: 0..5)
    const growthByProvince = {};
    data.forEach(d=>{
      const g = Number(d.growth||0);
      const p = d.province || 'نامشخص';
      (growthByProvince[p] ||= []).push(g);
    });
    const avgGrowth = {};
    for(const p in growthByProvince){
      const arr = growthByProvince[p];
      avgGrowth[p] = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
    }
    drawChart('chartGrowth','میانگین سطح رشد بر اساس استان', Object.keys(avgGrowth), Object.values(avgGrowth));

    // 7) تعداد نیوبلاد بر اساس استادیار
    const byAssistant = {};
    data.forEach(d=>{
      const a = d.assistant || 'نامشخص';
      byAssistant[a] = (byAssistant[a]||0)+1;
    });
    drawChart('chartAssistant','تعداد نیوبلادها بر اساس استادیار', Object.keys(byAssistant), Object.values(byAssistant));
  }

  function buildReceiptsTable(rows){
    const tbody = document.querySelector('#instTable tbody');
    tbody.innerHTML = '';
    rows.sort((a,b)=> b.date - a.date);
    const fdate = d => new Intl.DateTimeFormat('fa-IR').format(d);
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(r.name)}</td>
        <td>${esc(r.province)}</td>
        <td>${esc(r.assistant)}</td>
        <td>${fdate(r.date)}</td>
        <td>${r.amount ? r.amount.toLocaleString('fa-IR') : '-'}</td>
        <td>${r.receipt_url ? `<a href="${r.receipt_url}" target="_blank" rel="noopener">مشاهده فیش</a>` : '-'}</td>
      `;
      tbody.appendChild(tr);
    });
  }
</script>
</body>
</html>
