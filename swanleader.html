<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>داشبورد مدیریت - Swan Family</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />
  <style>html{-webkit-text-size-adjust:100%}</style>

  <!-- Backendless SDK -->
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>

  <!-- jQuery + jalaali-js -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.3/dist/jalaali.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --brand:#009688; --bg:#f6f7fb; --card:#fff; --txt:#111; --muted:#61646b;
      --fs:16.5px; --radius:14px; --shadow:0 10px 24px rgba(0,0,0,.06)
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Tahoma,system-ui,sans-serif;font-size:var(--fs)}
    header{background:#1f2937;color:#fff;padding:14px 12px;text-align:center}
    header h1{margin:0;font-size:18px;letter-spacing:.2px}

    .container{max-width:1180px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px;border:1px solid #e8ebef}

    label{display:block;margin-top:8px;font-weight:800}
    input,button,select{
      width:100%;padding:1rem;border:1px solid #cfd8dc;border-radius:10px;margin-top:6px;
      font-size:16px;color:#111;background:#fff
    }
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#607d8b}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}

    /* KPI */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi{background:#fafafa;border:1px solid #e7eaee;border-radius:12px;padding:12px}
    .kpi .title{color:#7a7f87}
    .kpi .val{font-size:22px;font-weight:900}
    @media (max-width:900px){ .kpis{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .kpis{grid-template-columns:1fr} }

    /* Builder */
    .builder{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:1080px){ .builder{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .builder{grid-template-columns:1fr} }
    .tile{border:1px solid #e7eaee;border-radius:12px;padding:12px;background:#fff}
    .tile h3{margin:0 0 8px 0;font-size:14px;color:#607d8b}
    .statlist{margin-top:8px;display:grid;gap:6px}
    .statrow{display:flex;justify-content:space-between;gap:8px;background:#fafafa;border:1px solid #f0f2f5;border-radius:10px;padding:8px}
    .statrow .k{color:#475569}
    .statrow .v{font-weight:800}

    /* Charts */
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:980px){ .charts{grid-template-columns:1fr} }
    .chart-card{background:#fff;border:1px solid #e7eaee;border-radius:12px;padding:12px}
    .chart-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}

    /* List */
    .list{display:grid;gap:8px;margin-top:8px}
    .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid #e7eaee;border-radius:12px;background:#fff;padding:10px}
    .item .line{display:flex;gap:8px;flex-wrap:wrap;color:#374151}
    .item .meta{font-size:13px;color:#4b5563}
    .badge{padding:2px 6px;border-radius:8px;font-size:12px}
    .badge-ok{background:#e8f5e9;color:#1b5e20}
    .badge-no{background:#fff3e0;color:#ef6c00}
    .actions{display:flex;gap:6px}
    .actions a{background:#37474f;color:#fff;padding:.55rem .8rem;border-radius:8px;text-decoration:none}

    .pager{display:flex;gap:8px;justify-content:center;margin:10px 0}
    .pager button{min-width:110px}

    /* tables */
    table.simple{width:100%;border-collapse:collapse}
    table.simple th, table.simple td{padding:8px;border-bottom:1px solid #f0f2f5}
    table.simple th{text-align:right;color:#607d8b}
    table.simple td{text-align:left}
  </style>
</head>
<body>
<header>
  <h1>داشبورد مدیریت Swan Family</h1>
</header>

<div class="container">

  <!-- لاگین مدیر -->
  <div class="card" id="loginCard" style="max-width:420px;margin:24px auto">
    <h3 style="margin:0 0 8px 0">ورود مدیر</h3>
    <label>نام کاربری</label>
    <input id="admUser" placeholder="نام کاربری">
    <label>رمز عبور</label>
    <input id="admPass" type="password" placeholder="رمز عبور">
    <button id="btnAdminLogin" style="margin-top:10px">ورود</button>
    <div id="loginMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- داشبورد -->
  <div id="dashCard" style="display:none">

    <div class="card">
      <div class="inline" style="justify-content:space-between">
        <div class="inline">
          <button id="btnBackupJSON" class="secondary">بکاپ JSON</button>
          <button id="btnBackupCSV"  class="secondary">بکاپ CSV</button>
        </div>
        <button id="btnLogout" style="background:#e53935">خروج</button>
      </div>
    </div>

    <!-- KPI کلی -->
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div class="title">تعداد کل نیوبلادها</div><div id="kCount" class="val">0</div></div>
        <div class="kpi"><div class="title">میانگین سطح رشد</div><div id="kGrowth" class="val">0</div></div>
        <div class="kpi"><div class="title">کل سوان‌کوین</div><div id="kCoins" class="val">0</div></div>
        <div class="kpi"><div class="title">قراردادهای امضا شده</div><div id="kContracts" class="val">0</div><div class="muted" id="kContractsPct">0%</div></div>
      </div>
    </div>

    <!-- سازنده آمار -->
    <div class="card">
      <h3 style="margin:0 0 10px 0;color:#374151">سازندهٔ آمار</h3>
      <div class="builder">
        <!-- استان -->
        <div class="tile">
          <h3>استان</h3>
          <select id="selProvince"></select>
          <div class="statlist" id="boxProvince"></div>
        </div>
        <!-- شهر -->
        <div class="tile">
          <h3>شهر</h3>
          <select id="selCity"></select>
          <div class="statlist" id="boxCity"></div>
        </div>
        <!-- استادیار -->
        <div class="tile">
          <h3>استادیار</h3>
          <select id="selAssistant"></select>
          <div class="statlist" id="boxAssistant"></div>
        </div>
        <!-- سایر فیلدها -->
        <div class="tile">
          <h3>سایر فیلدها</h3>
          <select id="selOther">
            <option value="">انتخاب کنید…</option>
            <option value="married">وضعیت تاهل: متاهل</option>
            <option value="single">وضعیت تاهل: مجرد</option>
            <option value="contract_yes">قرارداد: امضا شده</option>
            <option value="contract_no">قرارداد: بدون قرارداد</option>
            <option value="int_anatomy">علاقه‌مندی: آناتومی</option>
            <option value="int_ayurveda">علاقه‌مندی: آیورودا</option>
            <option value="int_marketing">علاقه‌مندی: بازاریابی</option>
          </select>
          <div class="statlist" id="boxOther"></div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">* آمار هر باکس شامل: تعداد نیوبلاد، ٪ رشد، تعداد کوین، تعداد قرارداد، تعداد متاهل، علاقه‌مندان مرتبط، و مجموع اقساط پرداخت‌نشده.</div>
    </div>

    <!-- نمودارها -->
    <div class="card">
      <div class="charts">
        <div class="chart-card">
          <div class="chart-toolbar">
            <strong class="muted">نمودار استان</strong>
            <select id="metricProvince">
              <option value="count">تعداد نیوبلاد</option>
              <option value="growthPct">٪ رشد</option>
              <option value="coins">تعداد کوین</option>
              <option value="married">تعداد متاهل</option>
              <option value="contracts">تعداد قرارداد</option>
              <option value="int_anatomy">علاقه‌مندی آناتومی</option>
              <option value="int_ayurveda">علاقه‌مندی آیورودا</option>
              <option value="int_marketing">علاقه‌مندی بازاریابی</option>
              <option value="unpaid">اقساط پرداخت‌نشده (جمع تومان)</option>
            </select>
          </div>
          <canvas id="chartProvince" height="220"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-toolbar">
            <strong class="muted">نمودار استادیار</strong>
            <select id="metricAssistant">
              <option value="count">تعداد نیوبلاد</option>
              <option value="growthPct">٪ رشد</option>
              <option value="coins">تعداد کوین</option>
              <option value="married">تعداد متاهل</option>
              <option value="contracts">تعداد قرارداد</option>
              <option value="int_anatomy">علاقه‌مندی آناتومی</option>
              <option value="int_ayurveda">علاقه‌مندی آیورودا</option>
              <option value="int_marketing">علاقه‌مندی بازاریابی</option>
              <option value="unpaid">اقساط پرداخت‌نشده (جمع تومان)</option>
            </select>
          </div>
          <canvas id="chartAssistant" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- ✅ گزارش اقساط پرداخت‌نشدهٔ سوان (ماهانه شمسی) -->
    <div class="card">
      <h3 style="margin:0 0 10px 0;color:#374151">گزارش ماهانه اقساط پرداخت‌نشدهٔ سوان</h3>
      <div class="muted" style="margin-bottom:8px">فقط اقساطی که <b>target = 'swan'</b> و <b>status ≠ 'done'</b> باشند.</div>

      <div class="inline" style="gap:16px;align-items:flex-start;flex-wrap:wrap">
        <div style="flex:1 1 320px;min-width:280px">
          <table id="tblSwanUnpaidByMonth" class="simple">
            <thead>
              <tr>
                <th>ماه (شمسی)</th>
                <th style="text-align:left">جمع (تومان)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="inline" style="margin-top:8px">
            <button id="btnExportSwanUnpaid" class="secondary" type="button">خروجی CSV</button>
          </div>
        </div>
        <div style="flex:1 1 420px;min-width:320px">
          <canvas id="chartSwanUnpaid" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- لیست -->
    <div class="card">
      <div class="list" id="list"></div>
      <div class="pager">
        <button id="prev">قبلی</button>
        <button id="next">بعدی</button>
      </div>
      <div class="muted" id="pageInfo" style="text-align:center"></div>
    </div>

  </div>
</div>

<script>
  // ===== Backendless =====
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  // ===== ورود ساده مدیر + لاگین واقعی Backendless =====
  const ADMIN_FIXED_USER = 'admin';
  const ADMIN_FIXED_PASS = 'swan';
  const ADMIN_BL_EMAIL   = 'admin@swanfamily.app';

  const loginCard = document.getElementById('loginCard');
  const dashCard  = document.getElementById('dashCard');
  function showLogin(){ loginCard.style.display='block'; dashCard.style.display='none'; }
  function showDash(){ loginCard.style.display='none'; dashCard.style.display='block'; }

  (async function initAdminSession(){
    if(sessionStorage.getItem('isAdmin')==='1'){
      try{ await Backendless.UserService.getCurrentUser(); }catch(_){}
      showDash(); resetPaging(); loadAll(true);
    }
  })();

  document.getElementById('btnAdminLogin').onclick = async ()=>{
    const u = admUser.value.trim(), p = admPass.value.trim(), m = loginMsg;
    m.textContent='در حال بررسی…';
    if(u!==ADMIN_FIXED_USER || p!==ADMIN_FIXED_PASS){ m.textContent='یوزر/پس اشتباه'; return; }
    try{
      await Backendless.UserService.login(ADMIN_BL_EMAIL, p, true);
      sessionStorage.setItem('isAdmin','1');
      m.textContent='ورود موفق.';
      showDash(); resetPaging(); loadAll(true);
    }catch(e){ m.textContent='خطا: ' + (e.message||e); }
  };
  document.getElementById('btnLogout').onclick = async ()=>{
    try{ await Backendless.UserService.logout(); }catch(_){}
    sessionStorage.removeItem('isAdmin'); showLogin();
  };

  // ===== ابزار کمکی تاریخ شمسی =====
  function toDate(x){ if(!x) return null; const d=new Date(x); return isNaN(d)?null:d; }
  function toJalaliStr(d){
    d = toDate(d); if(!d) return "—";
    const g={gy:d.getFullYear(),gm:d.getMonth()+1,gd:d.getDate()};
    const j= jalaali.toJalaali(g.gy,g.gm,g.gd);
    return `${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
  }

  // ===== مجموع‌ها و آمار =====
  function sumUnpaid(instalments){
    let s = 0;
    for(const it of (instalments||[])){
      const amt = Number(it?.amount||0);
      const done = (it?.status==='done');
      if(!done) s += (amt||0);
    }
    return s;
  }
  function metricsOf(rows){
    const count = rows.length;
    const coins = rows.reduce((s,r)=> s + (Array.isArray(r.coins)? r.coins.length : 0), 0);
    const contracts = rows.filter(r=> !!r.contract_signed).length;
    const married = rows.filter(r=> r.marital_status==='married').length;
    const growthAvg = count ? (rows.reduce((s,r)=> s + (+r.growth||0),0)/count) : 0; // 0..5
    const growthPct = Math.round((growthAvg/5)*100);
    const intAnat = rows.filter(r=> Array.isArray(r.interests) && r.interests.includes('anatomy')).length;
    const intAyur = rows.filter(r=> Array.isArray(r.interests) && r.interests.includes('ayurveda')).length;
    const intMkt = rows.filter(r=> Array.isArray(r.interests) && r.interests.includes('marketing')).length;
    const unpaid = rows.reduce((s,r)=> s + sumUnpaid(r.instalments), 0);
    return { count, coins, contracts, married, growthPct, intAnat, intAyur, intMkt, unpaid };
  }

  // ===== ساخت لیست یکتا از فیلدها =====
  function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }
  function getAllAssistantsFor(r){
    const arr = Array.isArray(r.assistants)&&r.assistants.length ? r.assistants : (r.assistant ? [r.assistant] : []);
    return arr;
  }

  // ===== دادهٔ کامل =====
  let cacheAll = [];
  async function loadAll(refresh=true){
    const tb = Backendless.Data.of('Newbloods');
    let offset=0, all=[], chunk=[];
    try{
      do{
        const qb = Backendless.DataQueryBuilder.create()
                     .setSortBy(['created DESC'])
                     .setPageSize(100).setOffset(offset);
        chunk = await tb.find(qb);
        all.push(...chunk);
        offset += 100;
      }while(chunk.length===100);

      cacheAll = all;
      if(refresh){
        updateKPIs(all);
        seedBuilderOptions(all);
        renderBuilder(all);
        drawCharts(all);
        renderSwanUnpaid(all);   // ✅ گزارش سوان
      }
      renderList();
    }catch(e){
      alert('خطا در بارگذاری داده‌ها: ' + (e.message||e));
    }
  }

  // ===== KPI کلی =====
  function updateKPIs(all){
    const m = metricsOf(all);
    kCount.textContent     = (m.count).toLocaleString('fa-IR');
    kGrowth.textContent    = (m.growthPct/20).toFixed(1); // نمایش نزدیک به مقیاس 0..5
    kCoins.textContent     = (m.coins).toLocaleString('fa-IR');
    kContracts.textContent = (m.contracts).toLocaleString('fa-IR');
    const pct = m.count ? Math.round((m.contracts / m.count) * 100) : 0;
    kContractsPct.textContent = pct + '%';
  }

  // ===== سازنده آمار: آپشن‌ها =====
  function seedBuilderOptions(all){
    // Provinces
    const provinces = ['(همه استان‌ها)', ...uniq(all.map(r=> (r.province||'—').trim()))];
    selProvince.innerHTML = provinces.map((n,i)=> `<option value="${i===0?'':n}">${n}</option>`).join('');

    // Cities
    const cities = ['(همه شهرها)', ...uniq(all.map(r=> (r.city||'—').trim()))];
    selCity.innerHTML = cities.map((n,i)=> `<option value="${i===0?'':n}">${n}</option>`).join('');

    // Assistants
    const assts = uniq(all.flatMap(getAllAssistantsFor));
    selAssistant.innerHTML = ['(همه استادیارها)', ...assts].map((n,i)=> `<option value="${i===0?'':n}">${n||'—'}</option>`).join('');
  }

  // ===== سازنده آمار: رندر هر باکس =====
  function renderStatsInto(el, rows, kind){
    const m = metricsOf(rows);
    const lines = [
      ['تعداد نیوبلاد', m.count.toLocaleString('fa-IR')],
      ['٪ رشد', m.growthPct + '%'],
      ['تعداد کوین', m.coins.toLocaleString('fa-IR')],
      ['تعداد قرارداد امضا شده', m.contracts.toLocaleString('fa-IR')],
      ['تعداد متاهل', m.married.toLocaleString('fa-IR')],
      ...(kind==='other' ? [] : [
        ['علاقه‌مندی آناتومی', m.intAnat.toLocaleString('fa-IR')],
        ['علاقه‌مندی آیورودا', m.intAyur.toLocaleString('fa-IR')],
        ['علاقه‌مندی بازاریابی', m.intMkt.toLocaleString('fa-IR')],
      ]),
      ['اقساط پرداخت‌نشده (تومان)', m.unpaid.toLocaleString('fa-IR')],
    ];
    el.innerHTML = lines.map(([k,v])=> `<div class="statrow"><div class="k">${k}</div><div class="v">${v}</div></div>`).join('');
  }

  function renderBuilder(all){
    // Province box
    const pv = selProvince.value;
    const rowsP = pv ? all.filter(r=> (r.province||'—').trim()===pv) : all;
    renderStatsInto(boxProvince, rowsP);

    // City box
    const cv = selCity.value;
    const rowsC = cv ? all.filter(r=> (r.city||'—').trim()===cv) : all;
    renderStatsInto(boxCity, rowsC);

    // Assistant box
    const av = selAssistant.value;
    const rowsA = av ? all.filter(r=> getAllAssistantsFor(r).includes(av)) : all;
    renderStatsInto(boxAssistant, rowsA);

    // Other box
    const ov = selOther.value;
    let rowsO = all;
    if(ov==='married') rowsO = all.filter(r=> r.marital_status==='married');
    else if(ov==='single') rowsO = all.filter(r=> r.marital_status==='single');
    else if(ov==='contract_yes') rowsO = all.filter(r=> !!r.contract_signed);
    else if(ov==='contract_no') rowsO = all.filter(r=> !r.contract_signed);
    else if(ov==='int_anatomy') rowsO = all.filter(r=> Array.isArray(r.interests)&&r.interests.includes('anatomy'));
    else if(ov==='int_ayurveda') rowsO = all.filter(r=> Array.isArray(r.interests)&&r.interests.includes('ayurveda'));
    else if(ov==='int_marketing') rowsO = all.filter(r=> Array.isArray(r.interests)&&r.interests.includes('marketing'));
    renderStatsInto(boxOther, rowsO, 'other');
  }

  selProvince.onchange = ()=> renderBuilder(cacheAll);
  selCity.onchange     = ()=> renderBuilder(cacheAll);
  selAssistant.onchange= ()=> renderBuilder(cacheAll);
  selOther.onchange    = ()=> renderBuilder(cacheAll);

  // ===== نمودارها =====
  let chartProvince, chartAssistant;

  function aggByProvinceMetric(all, metric){
    const map = new Map();
    for(const r of all){
      const k = (r.province||'—').trim();
      if(!map.has(k)) map.set(k, []);
      map.get(k).push(r);
    }
    const labels = [...map.keys()];
    const vals = labels.map(l=>{
      const rows = map.get(l);
      const m = metricsOf(rows);
      switch(metric){
        case 'count': return m.count;
        case 'growthPct': return m.growthPct;
        case 'coins': return m.coins;
        case 'married': return m.married;
        case 'contracts': return m.contracts;
        case 'int_anatomy': return m.intAnat;
        case 'int_ayurveda': return m.intAyur;
        case 'int_marketing': return m.intMkt;
        case 'unpaid': return m.unpaid;
        default: return 0;
      }
    });
    return { labels, vals };
  }

  // کمک: توزیع کسری برای استادیار (۱/k)
  function aggByAssistantMetricFractional(all, metric){
    const sumMap = {}; // label -> value
    const cntMap = {}; // برای growthAvg
    const growthSumMap = {};

    for(const r of all){
      const list = getAllAssistantsFor(r);
      const k = list.length || 1;
      const w = 1 / k;

      if(list.length===0){ list.push('—'); }

      for(const a of list){
        if(!(a in sumMap)) sumMap[a]=0;
        if(metric==='growthPct'){
          if(!(a in cntMap)) cntMap[a]=0;
          if(!(a in growthSumMap)) growthSumMap[a]=0;
          growthSumMap[a] += ((+r.growth||0) * w);
          cntMap[a] += w;
        }else if(metric==='count'){
          sumMap[a] += w;
        }else if(metric==='coins'){
          sumMap[a] += (Array.isArray(r.coins) ? r.coins.length : 0) * w;
        }else if(metric==='married'){
          sumMap[a] += (r.marital_status==='married') ? w : 0;
        }else if(metric==='contracts'){
          sumMap[a] += (!!r.contract_signed) ? w : 0;
        }else if(metric==='int_anatomy'){
          sumMap[a] += (Array.isArray(r.interests)&&r.interests.includes('anatomy')) ? w : 0;
        }else if(metric==='int_ayurveda'){
          sumMap[a] += (Array.isArray(r.interests)&&r.interests.includes('ayurveda')) ? w : 0;
        }else if(metric==='int_marketing'){
          sumMap[a] += (Array.isArray(r.interests)&&r.interests.includes('marketing')) ? w : 0;
        }else if(metric==='unpaid'){
          sumMap[a] += sumUnpaid(r.instalments) * w;
        }
      }
    }

    const labels = Object.keys(sumMap).sort();
    const vals = labels.map(a=>{
      if(metric==='growthPct'){
        const avg = (growthSumMap[a]||0) / (cntMap[a]||1);
        return Math.round((avg/5)*100);
      }
      const v = sumMap[a];
      if(metric==='unpaid') return Math.round(v);
      return Number(v.toFixed(2));
    });
    return { labels, vals };
  }

  function drawCharts(all){
    const ctxP = document.getElementById('chartProvince').getContext('2d');
    const ctxA = document.getElementById('chartAssistant').getContext('2d');

    function drawProvince(){
      const metric = metricProvince.value;
      const {labels, vals} = aggByProvinceMetric(all, metric);
      if(chartProvince) chartProvince.destroy();
      chartProvince = new Chart(ctxP, {
        type: 'bar',
        data: { labels, datasets: [{ label: metricLabel(metric), data: vals }] },
        options: {
          responsive:true, aspectRatio:2,
          scales: {
            y: { beginAtZero:true, min:0, ...(metric==='growthPct' ? {max:100} : {}) }
          }
        }
      });
    }
    function drawAssistant(){
      const metric = metricAssistant.value;
      const {labels, vals} = aggByAssistantMetricFractional(all, metric);
      if(chartAssistant) chartAssistant.destroy();
      chartAssistant = new Chart(ctxA, {
        type: 'bar',
        data: { labels, datasets: [{ label: metricLabel(metric), data: vals }] },
        options: {
          responsive:true, aspectRatio:2,
          scales: {
            y: { beginAtZero:true, min:0, ...(metric==='growthPct' ? {max:100} : {}) }
          }
        }
      });
    }

    function metricLabel(m){
      return ({
        count:'تعداد نیوبلاد',
        growthPct:'٪ رشد',
        coins:'تعداد کوین',
        married:'تعداد متاهل',
        contracts:'تعداد قرارداد',
        int_anatomy:'علاقه‌مندی آناتومی',
        int_ayurveda:'علاقه‌مندی آیورودا',
        int_marketing:'علاقه‌مندی بازاریابی',
        unpaid:'اقساط پرداخت‌نشده'
      })[m] || m;
    }

    metricProvince.onchange = drawProvince;
    metricAssistant.onchange = drawAssistant;
    drawProvince(); drawAssistant();
  }

  // ===== گزارش «اقساط پرداخت‌نشدهٔ سوان» (ماه شمسی) =====
  function toMonthKeyJalali(x){
    const d = new Date(x);
    if (isNaN(d)) return null;
    const g={gy:d.getFullYear(),gm:d.getMonth()+1,gd:d.getDate()};
    const j= jalaali.toJalaali(g.gy,g.gm,g.gd);
    const mm = String(j.jm).padStart(2,'0');
    return `${j.jy}/${mm}`;
  }

  function sumSwanUnpaidByMonth(rows){
    const map = {}; // key=YYYY/MM (jalali) -> sum
    for(const r of rows){
      const inst = Array.isArray(r.instalments) ? r.instalments : [];
      for(const it of inst){
        const amt = Number(it?.amount||0);
        const dt  = it?.date;
        const status = it?.status;
        const target = it?.target;
        if(!amt || !dt) continue;
        if(status==='done') continue;
        if(target!=='swan') continue;
        const key = toMonthKeyJalali(dt);
        if(!key) continue;
        map[key] = (map[key]||0) + amt;
      }
    }
    const keys = Object.keys(map).sort((a,b)=> a<b ? 1 : -1); // نزولی
    return keys.map(k=>({ month:k, total: map[k] }));
  }

  let chartSwanUnpaid;
  function renderSwanUnpaid(all){
    const rows = sumSwanUnpaidByMonth(all);
    // جدول
    const tb = document.querySelector('#tblSwanUnpaidByMonth tbody');
    tb.innerHTML = rows.length ? '' : '<tr><td colspan="2" style="padding:8px;color:#777">داده‌ای یافت نشد.</td></tr>';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.month}</td>
        <td style="text-align:left">${(r.total||0).toLocaleString('fa-IR')}</td>
      `;
      tb.appendChild(tr);
    });

    // چارت
    const ctx = document.getElementById('chartSwanUnpaid').getContext('2d');
    if(chartSwanUnpaid) chartSwanUnpaid.destroy();
    chartSwanUnpaid = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: rows.map(r=>r.month),
        datasets: [{ label:'جمع پرداخت‌نشدهٔ سوان (تومان)', data: rows.map(r=>r.total||0) }]
      },
      options:{
        responsive:true, aspectRatio:2,
        scales:{ y:{ beginAtZero:true, min:0 } }
      }
    });

    // خروجی CSV
    btnExportSwanUnpaid.onclick = ()=>{
      if(!rows.length){ alert('موردی برای خروجی نیست.'); return; }
      const head = 'ماه,مجموع_تومان';
      const body = rows.map(r=> `${r.month},${r.total}`).join('\n');
      const csv = head+'\n'+body;
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `swan_unpaid_monthly_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
    };
  }

  // ===== لیست صفحه‌ای =====
  let page = 0; const pageSize = 30;
  function resetPaging(){ page = 0; }
  prev.onclick = ()=>{ if(page>0){ page--; renderList(); } };
  next.onclick = ()=>{ if((page+1)*pageSize<cacheAll.length){ page++; renderList(); } };

  function renderList(){
    const list = document.getElementById('list');
    const start = page*pageSize;
    const rows = cacheAll.slice(start, start+pageSize);

    list.innerHTML = '';
    if(!rows.length){
      list.innerHTML = '<div class="muted">موردی یافت نشد.</div>';
    }else{
      rows.forEach(r=>{
        const coinsCount = Array.isArray(r.coins) ? r.coins.length : 0;
        const cd = r.course_date ? toJalaliStr(r.course_date) : '—';
        const cityPart = [r.province, r.city].filter(Boolean).join(' / ');
        const badge = r.contract_signed
          ? '<span class="badge badge-ok">قرارداد</span>'
          : '<span class="badge badge-no">بدون قرارداد</span>';

        const assistants = (Array.isArray(r.assistants) && r.assistants.length)
          ? r.assistants.join('، ')
          : (r.assistant || '—');

        const wrap = document.createElement('div');
        wrap.className = 'item';
        const qs = new URLSearchParams({ objectId: r.objectId, assistant: (r.assistant||'') });

        wrap.innerHTML = `
          <div>
            <div class="line"><b>${r.name||'—'}</b> <span class="muted">(${r.mobile||'—'})</span> ${badge}</div>
            <div class="meta">
              ${cityPart||'—'} | استادیار(ها): ${assistants} | رشد: ${'★'.repeat(+r.growth||0)} | کوین: ${coinsCount} | تاریخ دوره: ${cd}
            </div>
          </div>
          <div class="actions">
            <a href="index.html?${qs.toString()}" target="_self">ویرایش</a>
          </div>
        `;
        list.appendChild(wrap);
      });
    }

    pageInfo.textContent = `صفحه ${rows.length ? (page+1) : 0} از ${Math.max(1, Math.ceil(cacheAll.length/pageSize))}`;
  }

  // ===== بکاپ =====
  async function fetchAllNewbloodsRaw(){
    const store = [];
    let page = 0, pageSize = 100, chunk = [];
    const tb = Backendless.Data.of('Newbloods');
    do{
      const qb = Backendless.DataQueryBuilder.create()
                  .setPageSize(pageSize).setOffset(page*pageSize)
                  .setSortBy(['created DESC']);
      chunk = await tb.find(qb);
      store.push(...chunk);
      page++;
    }while(chunk.length === pageSize);
    return store;
  }
  function download(filename, text, mime='application/json'){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    URL.revokeObjectURL(url); a.remove();
  }
  function toCSV(arr){
    if(!arr.length) return '';
    const cols = [...new Set(arr.flatMap(o=>Object.keys(o)))];
    const esc = v => {
      if(v==null) return '';
      const s = typeof v === 'object' ? JSON.stringify(v) : String(v);
      return `"${s.replace(/"/g,'""')}"`;
    };
    const head = cols.map(esc).join(',');
    const rows = arr.map(o=> cols.map(c=>esc(o[c])).join(',')).join('\n');
    return head + '\n' + rows;
  }
  btnBackupJSON.onclick = async ()=>{
    try{
      const data = await fetchAllNewbloodsRaw();
      const fname = `swanfamily_newbloods_${new Date().toISOString().slice(0,10)}.json`;
      download(fname, JSON.stringify(data, null, 2), 'application/json');
    }catch(e){ alert('خطا در بکاپ JSON: ' + (e.message||e)); }
  };
  btnBackupCSV.onclick = async ()=>{
    try{
      const data = await fetchAllNewbloodsRaw();
      const fname = `swanfamily_newbloods_${new Date().toISOString().slice(0,10)}.csv`;
      download(fname, toCSV(data), 'text/csv;charset=utf-8');
    }catch(e){ alert('خطا در بکاپ CSV: ' + (e.message||e)); }
  };

  // ===== شروع =====
  if(sessionStorage.getItem('isAdmin')==='1'){ resetPaging(); loadAll(true); }
</script>
</body>
</html>
