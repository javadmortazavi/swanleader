<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>داشبورد مدیریت - Swan Family</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />
  <style>html{-webkit-text-size-adjust:100%}</style>

  <!-- Backendless SDK -->
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>

  <!-- jQuery + jalaali-js برای نمایش تاریخ شمسی -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.3/dist/jalaali.min.js"></script>

  <!-- Chart.js برای نمودارها -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{ --brand:#009688; --bg:#f6f7fb; --card:#fff; --txt:#222; --muted:#666 }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Tahoma,system-ui,sans-serif}
    header{background:#222;color:#fff;padding:12px;text-align:center}
    header h1{margin:0;font-size:18px}
    .container{max-width:1180px;margin:14px auto;padding:0 10px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:12px;margin-bottom:12px}

    label{display:block;margin-top:8px;font-weight:700}
    input,button,select{width:100%;padding:.9rem;border:1px solid #dde1e6;border-radius:10px;margin-top:6px;font-size:16px}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#607d8b}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:760px){ .row{grid-template-columns:1fr} }

    /* لاگین */
    .loginwrap{max-width:420px;margin:30px auto}

    /* نوار بالا + فیلترها */
    .topbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .filters{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    @media (max-width:980px){ .filters{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .filters{grid-template-columns:1fr} }
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* KPI ها */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .kpi{background:#fafafa;border:1px solid #eee;border-radius:12px;padding:10px}
    .kpi .title{color:#777}
    .kpi .val{font-size:20px;font-weight:900}
    @media (max-width:900px){ .kpis{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .kpis{grid-template-columns:1fr} }

    /* چارت ها */
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:980px){ .charts{grid-template-columns:1fr} }
    .chart-card{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}

    /* لیست */
    .list{display:grid;gap:8px;margin-top:10px}
    .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid #eee;border-radius:12px;background:#fff;padding:10px}
    .item .line{display:flex;gap:8px;flex-wrap:wrap;color:#444}
    .item .meta{font-size:13px;color:#555}
    .badge{padding:2px 6px;border-radius:8px;font-size:12px}
    .badge-ok{background:#e8f5e9;color:#1b5e20}
    .badge-no{background:#fff3e0;color:#ef6c00}
    .actions{display:flex;gap:6px}
    .actions a,.actions button{padding:.55rem .8rem;border-radius:8px;text-decoration:none}
    .actions a{background:#37474f;color:#fff}

    .pager{display:flex;gap:8px;justify-content:center;margin:10px 0}
    .pager button{min-width:110px}

    .msg{margin-top:8px;padding:.8rem;border-radius:10px;display:none}
    .ok{background:#e0f7f4;color:#00695c}
    .err{background:#ffebee;color:#c62828}
  </style>
</head>
<body>
<header>
  <h1>داشبورد مدیریت Swan Family</h1>
</header>

<div class="container">

  <!-- لاگین مدیر (بدون نمایش یوزر/پس روی UI) -->
  <div class="card loginwrap" id="loginCard">
    <h3 style="margin:0 0 8px 0">ورود مدیر</h3>
    <label>نام کاربری</label>
    <input id="admUser" placeholder="نام کاربری">
    <label>رمز عبور</label>
    <input id="admPass" type="password" placeholder="رمز عبور">
    <button id="btnAdminLogin" style="margin-top:10px">ورود</button>
    <div id="loginMsg" class="msg"></div>
  </div>

  <!-- داشبورد -->
  <div id="dashCard" style="display:none">

    <div class="card">
      <div class="topbar">
        <div class="inline">
          <button id="btnBackupJSON" class="secondary">بکاپ JSON</button>
          <button id="btnBackupCSV"  class="secondary">بکاپ CSV</button>
        </div>
        <div class="inline">
          <button id="btnLogout" style="background:#e53935">خروج</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">فیلترها</h3>
      <div class="filters">
        <input id="q" placeholder="جستجو: نام یا موبایل…">
        <input id="prov" placeholder="استان…">
        <input id="city" placeholder="شهر…">
        <input id="assistant" placeholder="استادیار…">
      </div>
      <div class="inline" style="margin-top:8px">
        <label style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="onlyContracted"> فقط دارای قرارداد
        </label>
        <button id="btnApply" class="secondary">اعمال فیلتر</button>
        <button id="btnReset" class="secondary">ریست</button>
      </div>
    </div>

    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <div class="title">تعداد کل نیوبلادها</div>
          <div id="kCount" class="val">0</div>
        </div>
        <div class="kpi">
          <div class="title">میانگین سطح رشد</div>
          <div id="kGrowth" class="val">0</div>
        </div>
        <div class="kpi">
          <div class="title">کل سوان‌کوین ثبت‌شده</div>
          <div id="kCoins" class="val">0</div>
        </div>
        <div class="kpi">
          <div class="title">قراردادهای امضا شده</div>
          <div id="kContracts" class="val">0</div>
          <div class="muted" id="kContractsPct">0%</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="charts">
        <div class="chart-card">
          <h3 style="margin:0 0 10px 0">آمار بر اساس استان</h3>
          <canvas id="chartProvince" height="200"></canvas>
        </div>
        <div class="chart-card">
          <h3 style="margin:0 0 10px 0">آمار بر اساس استادیار</h3>
          <canvas id="chartAssistant" height="200"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="list" id="list"></div>
      <div class="pager">
        <button id="prev">قبلی</button>
        <button id="next">بعدی</button>
      </div>
      <div class="muted" id="pageInfo" style="text-align:center"></div>
    </div>

  </div>
</div>

<script>
  // ===== Backendless =====
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  // ===== ورود ساده مدیر (سمت کاربر) + لاگین واقعی به Backendless =====
  const ADMIN_FIXED_USER = 'admin';
  const ADMIN_FIXED_PASS = 'swan';
  // ایمیلی که در Users ساخته‌ای:
  const ADMIN_BL_EMAIL  = 'admin@swanfamily.app';

  const loginCard = document.getElementById('loginCard');
  const dashCard  = document.getElementById('dashCard');
  function showLogin(){ loginCard.style.display='block'; dashCard.style.display='none'; }
  function showDash(){ loginCard.style.display='none'; dashCard.style.display='block'; }

  (async function initAdminSession(){
    if(sessionStorage.getItem('isAdmin')==='1'){
      // اگر سشن Backendless معتبر باشد، ادامه می‌دهیم
      try{ await Backendless.UserService.getCurrentUser(); }catch(_){}
      showDash(); resetPaging(); loadAll(true);
    }
  })();

  document.getElementById('btnAdminLogin').onclick = async ()=>{
    const u = (document.getElementById('admUser').value||'').trim();
    const p = (document.getElementById('admPass').value||'').trim();
    const m = document.getElementById('loginMsg');
    m.style.display='block'; m.className='msg'; m.textContent='در حال بررسی…';
    try{
      if(u!==ADMIN_FIXED_USER || p!==ADMIN_FIXED_PASS){
        m.className='msg err'; m.textContent='نام کاربری یا رمز نادرست است.'; return;
      }
      // ✅ لاگین واقعی به Backendless با کاربر مدیر
      await Backendless.UserService.login(ADMIN_BL_EMAIL, p, true);

      sessionStorage.setItem('isAdmin','1');
      m.className='msg ok'; m.textContent='ورود موفق.';
      showDash();
      resetPaging(); loadAll(true);
    }catch(e){
      console.error(e);
      m.className='msg err';
      m.textContent = 'خطا در ورود به سرور: ' + (e.message || e);
    }
  };

  document.getElementById('btnLogout').onclick = async ()=>{
    try{ await Backendless.UserService.logout(); }catch(_){}
    sessionStorage.removeItem('isAdmin');
    showLogin();
  };

  // ===== کمک‌ها =====
  function toDate(x){ if(!x) return null; const d=new Date(x); return isNaN(d)?null:d; }
  function toJalaliStr(d){
    d = toDate(d); if(!d) return "—";
    const g={gy:d.getFullYear(),gm:d.getMonth()+1,gd:d.getDate()};
    const j= jalaali.toJalaali(g.gy,g.gm,g.gd);
    return `${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
  }
  const star = n => '★'.repeat(n||0);
  const fmt  = n => (n||0).toLocaleString('fa-IR');

  // ===== فیلترها =====
  document.getElementById('btnApply').onclick = ()=>{ resetPaging(); loadAll(true); };
  document.getElementById('btnReset').onclick = ()=>{
    document.getElementById('q').value='';
    document.getElementById('prov').value='';
    document.getElementById('city').value='';
    document.getElementById('assistant').value='';
    document.getElementById('onlyContracted').checked=false;
    resetPaging(); loadAll(true);
  };

  // ===== صفحه‌بندی =====
  let page = 0; const pageSize = 30;
  function resetPaging(){ page = 0; }
  document.getElementById('prev').onclick = ()=>{ if(page>0){ page--; loadListOnly(); } };
  document.getElementById('next').onclick = ()=>{ page++; loadListOnly(); };

  function buildWhere(){
    const q  = (document.getElementById('q').value||'').trim();
    const pv = (document.getElementById('prov').value||'').trim();
    const ct = (document.getElementById('city').value||'').trim();
    const as = (document.getElementById('assistant').value||'').trim();
    const onlyC = document.getElementById('onlyContracted').checked;

    let where = '1=1';
    if(q){ where += ` AND (name LIKE '%${q}%' OR mobile LIKE '%${q}%')`; }
    if(pv){ where += ` AND province LIKE '%${pv}%'`; }
    if(ct){ where += ` AND city LIKE '%${ct}%'`; }
    if(as){ where += ` AND assistant LIKE '%${as}%'`; }
    if(onlyC){ where += ` AND contract_signed = true`; }
    return where;
  }

  // ===== داده‌ی کامل بر اساس فیلتر (برای KPI و نمودارها) =====
  let cacheAll = []; // کل داده‌های مطابق فیلتر برای ساخت KPI/نمودار
  async function loadAll(refreshKPIsAndCharts=false){
    const where = buildWhere();
    const tb = Backendless.Data.of('Newbloods');
    let offset = 0, all = [], chunk = [];
    try{
      do{
        const qb = Backendless.DataQueryBuilder.create()
                     .setWhereClause(where)
                     .setSortBy(['created DESC'])
                     .setPageSize(100)          // <= محدودیت Backendless
                     .setOffset(offset);
        chunk = await tb.find(qb);
        all.push(...chunk);
        offset += 100;                          // <= قدمِ بعدی
      }while(chunk.length===100);
      cacheAll = all;
      if(refreshKPIsAndCharts){ updateKPIs(all); drawCharts(all); }
      await loadListOnly(); // صفحه فعلی از نتایج
    }catch(e){
      console.error(e);
      alert('خطا در بارگذاری داده‌ها: ' + (e.message || e));
    }
  }

  // ===== KPI ها =====
  function updateKPIs(all){
    const count = all.length;
    const avgGrowth = count ? (all.reduce((s,r)=>s + (+r.growth||0),0)/count) : 0;
    const totalCoins = all.reduce((s,r)=> s + (Array.isArray(r.coins)? r.coins.length:0), 0);
    const contracts  = all.filter(r => !!r.contract_signed).length;

    document.getElementById('kCount').textContent     = fmt(count);
    document.getElementById('kGrowth').textContent    = (avgGrowth||0).toFixed(1);
    document.getElementById('kCoins').textContent     = fmt(totalCoins);
    document.getElementById('kContracts').textContent = fmt(contracts);
    const pct = count ? Math.round((contracts / count) * 100) : 0;
    document.getElementById('kContractsPct').textContent = pct + '%';
  }

  // ===== نمودارها =====
  let chartProvince, chartAssistant;

  function aggBy(items, keyFn){
    const map = new Map();
    for(const r of items){
      const k = keyFn(r) || '—';
      if(!map.has(k)) map.set(k, []);
      map.get(k).push(r);
    }
    return map;
  }

  function buildProvinceDataset(all){
    const g = aggBy(all, r=> (r.province||'—').trim());
    const labels = [...g.keys()];
    const counts = labels.map(l=> g.get(l).length);
    const avgGrowth = labels.map(l=>{
      const arr=g.get(l), c=arr.length;
      return c? (arr.reduce((s,r)=>s+(+r.growth||0),0)/c) : 0;
    });
    const contractsPct = labels.map(l=>{
      const arr=g.get(l), c=arr.length;
      const k=arr.filter(r=>!!r.contract_signed).length;
      return c? Math.round((k/c)*100):0;
    });
    return { labels, counts, avgGrowth, contractsPct };
  }

  function buildAssistantDataset(all){
    const g = aggBy(all, r=> (r.assistant||'—').trim());
    const labels = [...g.keys()];
    const counts = labels.map(l=> g.get(l).length);
    const avgGrowth = labels.map(l=>{
      const arr=g.get(l), c=arr.length;
      return c? (arr.reduce((s,r)=>s+(+r.growth||0),0)/c) : 0;
    });
    const contractsPct = labels.map(l=>{
      const arr=g.get(l), c=arr.length;
      const k=arr.filter(r=>!!r.contract_signed).length;
      return c? Math.round((k/c)*100):0;
    });
    return { labels, counts, avgGrowth, contractsPct };
  }

  function drawCharts(all){
    const p = buildProvinceDataset(all);
    const a = buildAssistantDataset(all);

    const ctxP = document.getElementById('chartProvince').getContext('2d');
    const ctxA = document.getElementById('chartAssistant').getContext('2d');

    if(chartProvince) chartProvince.destroy();
    if(chartAssistant) chartAssistant.destroy();

    chartProvince = new Chart(ctxP, {
      type: 'bar',
      data: {
        labels: p.labels,
        datasets: [
          { label:'تعداد', data: p.counts },
          { label:'میانگین رشد', data: p.avgGrowth },
          { label:'٪ قرارداد', data: p.contractsPct }
        ]
      },
      options: {
        responsive: true,
        aspectRatio: 2,
        scales: { y: { beginAtZero: true } }
      }
    });

    chartAssistant = new Chart(ctxA, {
      type: 'bar',
      data: {
        labels: a.labels,
        datasets: [
          { label:'تعداد', data: a.counts },
          { label:'میانگین رشد', data: a.avgGrowth },
          { label:'٪ قرارداد', data: a.contractsPct }
        ]
      },
      options: {
        responsive: true,
        aspectRatio: 2,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // ===== لیست صفحه‌ای (از cacheAll) =====
  async function loadListOnly(){
    const list = document.getElementById('list');
    const start = page*pageSize;
    const rows = cacheAll.slice(start, start+pageSize);

    list.innerHTML = '';
    if(!rows.length){
      list.innerHTML = '<div class="muted">موردی یافت نشد.</div>';
    }else{
      rows.forEach(r=>{
        const coinsCount = Array.isArray(r.coins) ? r.coins.length : 0;
        const cd = r.course_date ? toJalaliStr(r.course_date) : '—';
        const growthStars = star(+r.growth||0);
        const cityPart = [r.province, r.city].filter(Boolean).join(' / ');
        const badge = r.contract_signed
          ? '<span class="badge badge-ok">قرارداد</span>'
          : '<span class="badge badge-no">بدون قرارداد</span>';

        const wrap = document.createElement('div');
        wrap.className = 'item';

        const left = document.createElement('div');
        left.innerHTML = `
          <div class="line"><b>${r.name||'—'}</b> <span class="muted">(${r.mobile||'—'})</span> ${badge}</div>
          <div class="meta">
            ${cityPart||'—'} | استادیار: ${r.assistant||'—'} | رشد: ${growthStars} | کوین: ${fmt(coinsCount)} | تاریخ دوره: ${cd}
          </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'actions';
        const aEdit = document.createElement('a');
        const qs = new URLSearchParams({ objectId: r.objectId, assistant: (r.assistant||'') });
        aEdit.href = 'index.html?' + qs.toString();
        aEdit.textContent = 'ویرایش';
        aEdit.target = '_self';
        actions.appendChild(aEdit);

        wrap.appendChild(left);
        wrap.appendChild(actions);
        list.appendChild(wrap);
      });
    }

    document.getElementById('pageInfo').textContent =
      `صفحه ${rows.length ? (page+1) : 0} از ${Math.max(1, Math.ceil(cacheAll.length/pageSize))}`;
  }

  // ===== بکاپ‌ها =====
  async function fetchAllNewbloodsRaw(){
    const store = [];
    let page = 0, pageSize = 100, chunk = [];
    const tb = Backendless.Data.of('Newbloods');
    do{
      const qb = Backendless.DataQueryBuilder.create()
                  .setPageSize(pageSize).setOffset(page*pageSize)
                  .setSortBy(['created DESC']);
      chunk = await tb.find(qb);
      store.push(...chunk);
      page++;
    }while(chunk.length === pageSize);
    return store;
  }

  function download(filename, text, mime='application/json'){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    URL.revokeObjectURL(url); a.remove();
  }

  function toCSV(arr){
    if(!arr.length) return '';
    const cols = [...new Set(arr.flatMap(o=>Object.keys(o)))];
    const esc = v => {
      if(v==null) return '';
      const s = typeof v === 'object' ? JSON.stringify(v) : String(v);
      return `"${s.replace(/"/g,'""')}"`;
    };
    const head = cols.map(esc).join(',');
    const rows = arr.map(o=> cols.map(c=>esc(o[c])).join(',')).join('\n');
    return head + '\n' + rows;
  }

  document.getElementById('btnBackupJSON').onclick = async ()=>{
    try{
      const data = await fetchAllNewbloodsRaw();
      const fname = `swanfamily_newbloods_${new Date().toISOString().slice(0,10)}.json`;
      download(fname, JSON.stringify(data, null, 2), 'application/json');
    }catch(e){ alert('خطا در بکاپ JSON: ' + (e.message||e)); console.error(e); }
  };

  document.getElementById('btnBackupCSV').onclick = async ()=>{
    try{
      const data = await fetchAllNewbloodsRaw();
      const fname = `swanfamily_newbloods_${new Date().toISOString().slice(0,10)}.csv`;
      download(fname, toCSV(data), 'text/csv;charset=utf-8');
    }catch(e){ alert('خطا در بکاپ CSV: ' + (e.message||e)); console.error(e); }
  };

  // ===== شروع (بعد از ورود) =====
  if(sessionStorage.getItem('isAdmin')==='1'){
    resetPaging(); loadAll(true);
  }
</script>
</body>
</html>
