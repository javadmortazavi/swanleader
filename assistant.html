<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>پنل استادیار - Swan Family</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <style>
    :root { --brand:#009688; }
    *{box-sizing:border-box}
    body{font-family:Tahoma,system-ui,sans-serif;background:#f7f7f7;margin:0}
    header{background:#222;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 16px;gap:10px}
    header h1{font-size:18px;margin:0}
    a.btn,button{background:var(--brand);color:#fff;padding:8px 12px;border-radius:10px;border:none;text-decoration:none;cursor:pointer}
    a.btn:hover,button:hover{opacity:.92}
    .wrap{max-width:1100px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:14px}
    .hidden{display:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input,select{padding:.7rem;border:1px solid #dedede;border-radius:10px;width:100%}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:right;vertical-align:middle}
    th{background:#fafafa}
    .topbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
    .muted{color:#666;font-size:.92rem}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    @media (max-width:700px){
      header{flex-direction:column;align-items:stretch}
      header .actions{display:flex;gap:8px;flex-wrap:wrap}
    }
  </style>
</head>
<body>

<header>
  <h1>پنل استادیار</h1>
  <div class="actions">
    <span id="whoami" class="muted"></span>
    <!-- دکمه افزودن قبل از لاگین پنهان است -->
    <a id="addLink" class="btn hidden" href="#">+ افزودن نیوبلاد</a>
    <button type="button" onclick="logout()">خروج</button>
  </div>
</header>

<!-- ورود/ثبت‌نام -->
<div id="auth" class="wrap">
  <h2>ورود / ثبت‌نام</h2>
  <p class="muted">برای ثبت و مدیریت نیوبلادها ابتدا وارد شوید.</p>
  <div class="row" style="margin-top:10px">
    <input id="email" type="email" placeholder="ایمیل">
    <input id="password" type="password" placeholder="رمز عبور">
  </div>
  <div class="row" style="margin-top:10px">
    <input id="displayName" type="text" placeholder="نام نمایشی (مثال: جواد مرتضوی)">
    <div style="display:flex;gap:8px;align-items:center">
      <button type="button" onclick="login()">ورود</button>
      <button type="button" onclick="signup()">ثبت‌نام</button>
    </div>
  </div>
</div>

<!-- اپلیکیشن -->
<div id="app" class="wrap hidden">
  <div class="topbar">
    <div>
      <h2>نیوبلادهای من</h2>
      <div class="muted">فقط رکوردهایی که با نام نمایشی شما ثبت شده‌اند.</div>
    </div>
    <div class="row" style="grid-template-columns:1fr 1fr;gap:8px;align-items:center;min-width:280px">
      <input id="q" placeholder="جستجو: نام، موبایل، شهر، استان">
      <input id="byProvince" placeholder="فیلتر استان (خالی=همه)">
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>نام</th>
        <th>موبایل</th>
        <th>استان / شهر</th>
        <th>تعداد اقساط</th>
        <th>سطح رشد</th>
        <th>تاریخ ایجاد</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
  // ===== Backendless =====
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  let CURRENT_USER = null;
  let RAW = [];

  // ✅ آدرس قطعی فرم روی Vercel (تا حتماً index اصلی باز شود)
  const FORM_BASE = "https://swanfamily.vercel.app/";

  // ===== ثبت‌نام/ورود =====
  async function signup(){
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const displayName = document.getElementById('displayName').value.trim();
    if(!email || !password) return alert("ایمیل و رمز را وارد کنید");
    if(!displayName) return alert("نام نمایشی را وارد کنید");
    try{
      const user = new Backendless.User();
      user.email = email;
      user.password = password;
      user.name = displayName; // نام نمایشی
      await Backendless.UserService.register(user);
      await Backendless.UserService.login(email, password, true);
      await afterLogin();
    }catch(e){
      console.error(e);
      alert("ثبت‌نام/ورود ناموفق: " + (e.message||e));
    }
  }

  async function login(){
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if(!email || !password) return alert("ایمیل و رمز را وارد کنید");
    try{
      await Backendless.UserService.login(email, password, true);
      await afterLogin();
    }catch(e){
      console.error(e);
      alert("ورود ناموفق: " + (e.message||e));
    }
  }

  async function logout(){
    try{ await Backendless.UserService.logout(); }catch(_){}
    location.reload();
  }

  // ===== بعد از ورود =====
  async function afterLogin(){
    document.getElementById('auth').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');

    CURRENT_USER = await Backendless.UserService.getCurrentUser();
    const assistantName = (CURRENT_USER && CURRENT_USER.name) || 'بدون‌نام'; // فقط name
    document.getElementById('whoami').textContent = "ورود: " + assistantName;

    // 👇 باز کردن index اصلی + پارامتر ضدکش
    const addLink = document.getElementById('addLink');
    addLink.onclick = (e)=>{
      e.preventDefault();
      const url = new URL('index.html', FORM_BASE);
      url.searchParams.set('assistant', assistantName);
      url.searchParams.set('v', Date.now().toString()); // جلوگیری از کش
      window.location.href = url.toString();
    };
    addLink.classList.remove('hidden');  // دکمه بعد از لاگین نمایش داده شود

    // رویدادهای جستجو/فیلتر
    document.getElementById('q').addEventListener('input', renderList);
    document.getElementById('byProvince').addEventListener('input', renderList);

    // بارگذاری رکوردهای من
    await loadMine();
  }

  // ===== دریافت رکوردهای من =====
  async function loadMine(){
    const name = (CURRENT_USER && CURRENT_USER.name) || '';
    if(!name){ RAW = []; return renderList(); }

    const safe = name.replace(/'/g, "''");
    const qb = Backendless.DataQueryBuilder.create()
               .setWhereClause(`assistant = '${safe}'`)
               .setSortBy(['created DESC'])
               .setPageSize(100);
    try{
      RAW = await Backendless.Data.of('Newbloods').find(qb);
      renderList();
    }catch(e){
      console.error(e);
      alert('خواندن داده‌ها ناموفق بود.');
    }
  }

  // ===== نمایش لیست =====
  function renderList(){
    const q = (document.getElementById('q').value||'').trim();
    const p = (document.getElementById('byProvince').value||'').trim();

    const hit = (s)=> (s||'').toString().includes(q);
    const list = RAW.filter(r=>{
      const okQ = !q || hit(r.name)||hit(r.mobile)||hit(r.city)||hit(r.province);
      const okP = !p || (r.province||'')===p;
      return okQ && okP;
    });

    const tb = document.getElementById('rows');
    tb.innerHTML = '';
    list.forEach(r=>{
      const instCount = Array.isArray(r.instalments) ? r.instalments.length : 0; // ← ستون شما
      const grow = Number(r.growth||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(r.name||'-')}</td>
        <td>${esc(r.mobile||'-')}</td>
        <td>${esc(r.province||'-')} / ${esc(r.city||'-')}</td>
        <td>${instCount}</td>
        <td>${'★'.repeat(grow)}${'☆'.repeat(Math.max(0,5-grow))}</td>
        <td>${r.created ? new Date(r.created).toLocaleDateString('fa-IR') : '-'}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function esc(s){return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}

  // اگر سشن قبلی وجود داشت، خودکار وارد شو (اما دکمه افزودن تا afterLogin پنهان است)
  (async ()=>{
    try{
      const cu = await Backendless.UserService.getCurrentUser();
      if(cu){ await afterLogin(); }
    }catch(_){}
  })();
</script>

</body>
</html>
