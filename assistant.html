<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù¾Ù†Ù„ Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø± - Swan Family</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <style>
    :root { --brand:#009688; }
    *{box-sizing:border-box}
    body{font-family:Tahoma,system-ui,sans-serif;background:#f7f7f7;margin:0}
    header{background:#222;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 16px;gap:10px}
    header h1{font-size:18px;margin:0}
    a.btn,button{background:var(--brand);color:#fff;padding:8px 12px;border-radius:10px;border:none;text-decoration:none;cursor:pointer}
    a.btn:hover,button:hover{opacity:.92}
    .wrap{max-width:1100px;margin:20px auto;background:#fff;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:14px}
    .hidden{display:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input,select{padding:.7rem;border:1px solid #dedede;border-radius:10px;width:100%}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:.6rem;border-bottom:1px solid #eee;text-align:right;vertical-align:middle}
    th{background:#fafafa}
    .topbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
    .muted{color:#666;font-size:.92rem}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    @media (max-width:700px){
      header{flex-direction:column;align-items:stretch}
      header .actions{display:flex;gap:8px;flex-wrap:wrap}
    }
  </style>
</head>
<body>

<header>
  <h1>Ù¾Ù†Ù„ Ø§Ø³ØªØ§Ø¯ÛŒØ§Ø±</h1>
  <div class="actions">
    <span id="whoami" class="muted"></span>
    <!-- Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† Ù‚Ø¨Ù„ Ø§Ø² Ù„Ø§Ú¯ÛŒÙ† Ù¾Ù†Ù‡Ø§Ù† Ø§Ø³Øª -->
    <a id="addLink" class="btn hidden" href="#">+ Ø§ÙØ²ÙˆØ¯Ù† Ù†ÛŒÙˆØ¨Ù„Ø§Ø¯</a>
    <button type="button" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<!-- ÙˆØ±ÙˆØ¯/Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… -->
<div id="auth" class="wrap">
  <h2>ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h2>
  <p class="muted">Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÛŒÙˆØ¨Ù„Ø§Ø¯Ù‡Ø§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.</p>
  <div class="row" style="margin-top:10px">
    <input id="email" type="email" placeholder="Ø§ÛŒÙ…ÛŒÙ„">
    <input id="password" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  </div>
  <div class="row" style="margin-top:10px">
    <input id="displayName" type="text" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (Ù…Ø«Ø§Ù„: Ø¬ÙˆØ§Ø¯ Ù…Ø±ØªØ¶ÙˆÛŒ)">
    <div style="display:flex;gap:8px;align-items:center">
      <button type="button" onclick="login()">ÙˆØ±ÙˆØ¯</button>
      <button type="button" onclick="signup()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
    </div>
  </div>
</div>

<!-- Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† -->
<div id="app" class="wrap hidden">
  <div class="topbar">
    <div>
      <h2>Ù†ÛŒÙˆØ¨Ù„Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ù†</h2>
      <div class="muted">ÙÙ‚Ø· Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.</div>
    </div>
    <div class="row" style="grid-template-columns:1fr 1fr;gap:8px;align-items:center;min-width:280px">
      <input id="q" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ù†Ø§Ù…ØŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ØŒ Ø´Ù‡Ø±ØŒ Ø§Ø³ØªØ§Ù†">
      <input id="byProvince" placeholder="ÙÛŒÙ„ØªØ± Ø§Ø³ØªØ§Ù† (Ø®Ø§Ù„ÛŒ=Ù‡Ù…Ù‡)">
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ù†Ø§Ù…</th>
        <th>Ù…ÙˆØ¨Ø§ÛŒÙ„</th>
        <th>Ø§Ø³ØªØ§Ù† / Ø´Ù‡Ø±</th>
        <th>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·</th>
        <th>Ø³Ø·Ø­ Ø±Ø´Ø¯</th>
        <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
  // ===== Backendless =====
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  let CURRENT_USER = null;
  let RAW = [];

  // âœ… Ø¢Ø¯Ø±Ø³ Ù‚Ø·Ø¹ÛŒ ÙØ±Ù… Ø±ÙˆÛŒ Vercel (ØªØ§ Ø­ØªÙ…Ø§Ù‹ index Ø§ØµÙ„ÛŒ Ø¨Ø§Ø² Ø´ÙˆØ¯)
  const FORM_BASE = "https://swanfamily.vercel.app/";

  // ===== Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…/ÙˆØ±ÙˆØ¯ =====
  async function signup(){
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const displayName = document.getElementById('displayName').value.trim();
    if(!email || !password) return alert("Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
    if(!displayName) return alert("Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
    try{
      const user = new Backendless.User();
      user.email = email;
      user.password = password;
      user.name = displayName; // Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ
      await Backendless.UserService.register(user);
      await Backendless.UserService.login(email, password, true);
      await afterLogin();
    }catch(e){
      console.error(e);
      alert("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…/ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚: " + (e.message||e));
    }
  }

  async function login(){
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if(!email || !password) return alert("Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
    try{
      await Backendless.UserService.login(email, password, true);
      await afterLogin();
    }catch(e){
      console.error(e);
      alert("ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚: " + (e.message||e));
    }
  }

  async function logout(){
    try{ await Backendless.UserService.logout(); }catch(_){}
    location.reload();
  }

  // ===== Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ±ÙˆØ¯ =====
  async function afterLogin(){
    document.getElementById('auth').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');

    CURRENT_USER = await Backendless.UserService.getCurrentUser();
    const assistantName = (CURRENT_USER && CURRENT_USER.name) || 'Ø¨Ø¯ÙˆÙ†â€ŒÙ†Ø§Ù…'; // ÙÙ‚Ø· name
    document.getElementById('whoami').textContent = "ÙˆØ±ÙˆØ¯: " + assistantName;

    // ğŸ‘‡ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† index Ø§ØµÙ„ÛŒ + Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø¶Ø¯Ú©Ø´
    const addLink = document.getElementById('addLink');
    addLink.onclick = (e)=>{
      e.preventDefault();
      const url = new URL('index.html', FORM_BASE);
      url.searchParams.set('assistant', assistantName);
      url.searchParams.set('v', Date.now().toString()); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´
      window.location.href = url.toString();
    };
    addLink.classList.remove('hidden');  // Ø¯Ú©Ù…Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯ÛŒÙ† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯

    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ/ÙÛŒÙ„ØªØ±
    document.getElementById('q').addEventListener('input', renderList);
    document.getElementById('byProvince').addEventListener('input', renderList);

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù…Ù†
    await loadMine();
  }

  // ===== Ø¯Ø±ÛŒØ§ÙØª Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù…Ù† =====
  async function loadMine(){
    const name = (CURRENT_USER && CURRENT_USER.name) || '';
    if(!name){ RAW = []; return renderList(); }

    const safe = name.replace(/'/g, "''");
    const qb = Backendless.DataQueryBuilder.create()
               .setWhereClause(`assistant = '${safe}'`)
               .setSortBy(['created DESC'])
               .setPageSize(100);
    try{
      RAW = await Backendless.Data.of('Newbloods').find(qb);
      renderList();
    }catch(e){
      console.error(e);
      alert('Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.');
    }
  }

  // ===== Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª =====
  function renderList(){
    const q = (document.getElementById('q').value||'').trim();
    const p = (document.getElementById('byProvince').value||'').trim();

    const hit = (s)=> (s||'').toString().includes(q);
    const list = RAW.filter(r=>{
      const okQ = !q || hit(r.name)||hit(r.mobile)||hit(r.city)||hit(r.province);
      const okP = !p || (r.province||'')===p;
      return okQ && okP;
    });

    const tb = document.getElementById('rows');
    tb.innerHTML = '';
    list.forEach(r=>{
      const instCount = Array.isArray(r.instalments) ? r.instalments.length : 0; // â† Ø³ØªÙˆÙ† Ø´Ù…Ø§
      const grow = Number(r.growth||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(r.name||'-')}</td>
        <td>${esc(r.mobile||'-')}</td>
        <td>${esc(r.province||'-')} / ${esc(r.city||'-')}</td>
        <td>${instCount}</td>
        <td>${'â˜…'.repeat(grow)}${'â˜†'.repeat(Math.max(0,5-grow))}</td>
        <td>${r.created ? new Date(r.created).toLocaleDateString('fa-IR') : '-'}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function esc(s){return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}

  // Ø§Ú¯Ø± Ø³Ø´Ù† Ù‚Ø¨Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªØŒ Ø®ÙˆØ¯Ú©Ø§Ø± ÙˆØ§Ø±Ø¯ Ø´Ùˆ (Ø§Ù…Ø§ Ø¯Ú©Ù…Ù‡ Ø§ÙØ²ÙˆØ¯Ù† ØªØ§ afterLogin Ù¾Ù†Ù‡Ø§Ù† Ø§Ø³Øª)
  (async ()=>{
    try{
      const cu = await Backendless.UserService.getCurrentUser();
      if(cu){ await afterLogin(); }
    }catch(_){}
  })();
</script>

</body>
</html>
