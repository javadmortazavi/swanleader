<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>پنل مدیریت نیوبلادها - Swan Leader</title>
<style>
  body { font-family: tahoma, sans-serif; background: #f9f9f9; margin:0; padding:0; }
  header { background:#222; color:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { font-size:18px; margin:0; }
  a.pill, button { background:#0084ff; color:#fff; padding:6px 12px; border-radius:5px; text-decoration:none; border:none; cursor:pointer; }
  a.pill:hover, button:hover { background:#005fcc; }
  .hidden { display:none; }
  main { padding:20px; }
  table { border-collapse: collapse; width:100%; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:6px; text-align:center; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/backendless/8.1.4/backendless.min.js"></script>
</head>
<body>

<header>
  <h1>پنل استادیار</h1>
  <div>
    <span id="whoami"></span>
    <a id="addLink" class="pill" href="#">+ افزودن نیوبلاد</a>
    <button onclick="logout()">خروج</button>
  </div>
</header>

<main>
  <section id="auth">
    <h2>ورود</h2>
    <input type="email" id="loginEmail" placeholder="ایمیل"><br><br>
    <input type="password" id="loginPass" placeholder="رمز عبور"><br><br>
    <button onclick="login()">ورود</button>
  </section>

  <section id="app" class="hidden">
    <h2>لیست نیوبلادهای من</h2>
    <table>
      <thead>
        <tr>
          <th>نام</th>
          <th>تاریخ ثبت</th>
          <th>استان</th>
          <th>شهر</th>
        </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>
  </section>
</main>

<script>
const APP_ID = "8D939181-02F9-4505-92A9-57A80D713F65";
const API_KEY = "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8";
Backendless.initApp(APP_ID, API_KEY);

let CURRENT_USER = null;

async function login(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  try {
    await Backendless.UserService.login(email, pass, true);
    afterLogin();
  } catch(err){
    alert("خطا در ورود: " + err.message);
  }
}

async function afterLogin(){
  document.getElementById('auth').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');

  CURRENT_USER = await Backendless.UserService.getCurrentUser();
  const assistantName = (CURRENT_USER && (CURRENT_USER.name || CURRENT_USER.email)) || 'بدون‌نام';
  document.getElementById('whoami').textContent = "ورود: " + assistantName;

  // مسیر فرم
  const FORM_BASE = location.href.replace(/assistant\.html(\?.*)?$/,'');
  // اگر در ریپوی جداست، این رو دستی بزار:
  // const FORM_BASE = "https://javadmortazavi.github.io/swan-newblood/";

  const addUrl = new URL('index.html', FORM_BASE);
  addUrl.searchParams.set('assistant', assistantName);
  document.getElementById('addLink').href = addUrl.toString();

  loadMine();
}

async function loadMine(){
  if(!CURRENT_USER) return;
  try {
    const data = await Backendless.Data.of("Newbloods")
      .find({ where: `assistant='${CURRENT_USER.name || CURRENT_USER.email}'` });
    renderList(data);
  } catch(err){
    console.error(err);
  }
}

function renderList(list){
  const tbody = document.getElementById('listBody');
  tbody.innerHTML = "";
  list.forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.name || ''}</td>
      <td>${item.created ? new Date(item.created).toLocaleDateString('fa-IR') : ''}</td>
      <td>${item.province || ''}</td>
      <td>${item.city || ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function logout(){
  Backendless.UserService.logout().then(()=>{
    location.reload();
  });
}
</script>

</body>
</html>
