<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>پنل استادیار - Swan Family</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />

  <!-- Backendless SDK -->
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>

  <!-- jQuery + jalaali-js برای نمایش تاریخ شمسی -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.3/dist/jalaali.min.js"></script>

  <style>
    :root{ --brand:#009688; --bg:#f6f7fb; --card:#fff; --txt:#111; --muted:#555; --fs:17px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Tahoma,system-ui,sans-serif;font-size:var(--fs)}
    header{background:#222;color:#fff;text-align:center;padding:12px}
    header h1{margin:0;font-size:calc(var(--fs) + 1px)}

    .container{max-width:980px;margin:14px auto;padding:0 10px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.06);padding:12px;margin-bottom:12px}

    label{display:block;margin-top:8px;font-weight:800;font-size:calc(var(--fs) - 1px);color:#111}
    input,button,select{
      width:100%;padding:1rem;border:1px solid #9ea7ad;border-radius:10px;
      margin-top:6px;font-size:calc(var(--fs) + 1px);color:#111;background:#fff
    }
    input::placeholder, select::placeholder{color:#444}
    input:focus, select:focus{outline:none;border-color:#00796b;box-shadow:0 0 0 3px rgba(0,121,107,.12)}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#607d8b}

    .tabs{display:flex;gap:8px;margin-bottom:8px}
    .tabs button{flex:1}
    .hidden{display:none}

    .topbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .filters{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:560px){ .filters{grid-template-columns:1fr} }

    .list{display:grid;gap:8px;margin-top:10px}
    .item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid #d9dee2;border-radius:12px;background:#fff;padding:12px}
    .item .line{display:flex;gap:8px;flex-wrap:wrap}
    .item .meta{font-size:calc(var(--fs) - 1px);color:#333}
    .badge{padding:2px 6px;border-radius:8px;font-size:calc(var(--fs) - 3px)}
    .badge-ok{background:#e8f5e9;color:#1b5e20}
    .badge-no{background:#fff3e0;color:#ef6c00}
    .actions{display:flex;gap:6px}
    .actions a{background:#37474f;color:#fff;padding:.65rem .9rem;border-radius:8px;text-decoration:none}

    .pager{display:flex;gap:8px;justify-content:center;margin:10px 0}
    .pager button{min-width:110px}

    .msg{margin-top:8px;padding:.9rem;border-radius:10px;display:none}
    .ok{background:#e0f7f4;color:#00695c}
    .err{background:#ffebee;color:#c62828}

    .muted{color:#555}

    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .kpi{background:#fff;border:1px solid #d9dee2;border-radius:12px;padding:12px}
    .kpi h3{margin:0 0 6px 0;font-size:calc(var(--fs) - 2px);color:#607d8b}
    .kpi .num{font-size:calc(var(--fs) + 3px);font-weight:900}
    @media (max-width:800px){ .kpis{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .kpis{grid-template-columns:1fr} }

    .row-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ghost{background:#eceff1;color:#263238}

    .a11y{display:flex;gap:6px;align-items:center}
    .a11y button{padding:.45rem .7rem;border-radius:8px}
  </style>
</head>
<body>
<header>
  <h1>پنل استادیار Swan Family</h1>
</header>

<div class="container">

  <!-- احراز هویت -->
  <div class="card" id="authCard">
    <div class="tabs">
      <button id="tabLogin"  class="secondary">ورود</button>
      <button id="tabSignup" class="secondary">ثبت‌نام</button>
    </div>

    <div id="loginPane">
      <label>ایمیل</label>
      <input id="loginEmail" type="email" placeholder="you@example.com" />
      <label>رمز عبور</label>
      <input id="loginPass" type="password" placeholder="******" />
      <button id="btnLogin" style="margin-top:10px">ورود</button>
      <div id="loginMsg" class="msg"></div>
    </div>

    <div id="signupPane" class="hidden">
      <label>نام و نام خانوادگی</label>
      <input id="suName" placeholder="مثلاً: جواد مرتضوی" />
      <label>ایمیل</label>
      <input id="suEmail" type="email" placeholder="you@example.com" />
      <label>رمز عبور</label>
      <input id="suPass" type="password" placeholder="******" />
      <button id="btnSignup" style="margin-top:10px">ثبت‌نام</button>
      <div id="signupMsg" class="msg"></div>
    </div>
  </div>

  <!-- داشبورد -->
  <div id="dashCard" class="hidden">
    <div class="card">
      <div class="topbar">
        <div class="muted" id="welcome"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <div class="a11y">
            <button id="fsMinus" class="ghost" type="button">A−</button>
            <button id="fsPlus"  class="ghost" type="button">A+</button>
          </div>
          <a id="btnAddNew" class="actions" href="#" style="background:#009688;color:#fff;padding:.75rem 1rem;border-radius:10px;text-decoration:none">+ افزودن نیوبلاد</a>
          <button id="btnLogout" style="background:#e53935">خروج</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="kpis" id="kpisWrap" style="display:none">
        <div class="kpi"><h3>تعداد قراردادها</h3><div class="num" id="kpiContracts">0</div></div>
        <div class="kpi"><h3>مجموع مبلغ اقساط</h3><div class="num" id="kpiTotal">0</div></div>
        <div class="kpi"><h3>پرداخت‌شده</h3><div class="num" id="kpiPaid">0</div></div>
        <div class="kpi"><h3>باقی‌مانده</h3><div class="num" id="kpiRemain">0</div></div>
        <div class="kpi"><h3>نیوبلادهای باز</h3><div class="num" id="kpiOpen">0</div></div>
        <div class="kpi"><h3>مجموع سوان‌کوین</h3><div class="num" id="kpiCoins">0</div></div>
      </div>
    </div>

    <div class="card">
      <div class="filters">
        <input id="q" placeholder="جستجو: نام یا موبایل…">
        <input id="city" placeholder="استان/شهر…">
      </div>
      <div class="row-actions">
        <button id="btnApply" class="secondary">اعمال فیلتر</button>
        <button id="btnReset" class="secondary">ریست</button>
        <button id="btnExport" class="ghost">خروجی CSV لیست</button>
      </div>
    </div>

    <div class="card">
      <div class="list" id="list"></div>
      <div class="pager">
        <button id="prev">قبلی</button>
        <button id="next">بعدی</button>
      </div>
      <div id="pageInfo" style="text-align:center" class="muted"></div>
    </div>
  </div>
</div>

<script>
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  const loginPane  = document.getElementById('loginPane');
  const signupPane = document.getElementById('signupPane');
  document.getElementById('tabLogin').onclick  = ()=>{ loginPane.classList.remove('hidden'); signupPane.classList.add('hidden'); };
  document.getElementById('tabSignup').onclick = ()=>{ signupPane.classList.remove('hidden'); loginPane.classList.add('hidden'); };

  const root = document.documentElement;
  function applyScale(){ const s = Number(localStorage.getItem('uiScale')||1); root.style.setProperty('--fs', Math.max(14, Math.min(22, 17*s)) + 'px'); }
  document.getElementById('fsPlus').onclick = ()=>{ const s=Number(localStorage.getItem('uiScale')||1)+0.1; localStorage.setItem('uiScale', s.toFixed(2)); applyScale(); };
  document.getElementById('fsMinus').onclick= ()=>{ const s=Number(localStorage.getItem('uiScale')||1)-0.1; localStorage.setItem('uiScale', s.toFixed(2)); applyScale(); };
  applyScale();

  const authCard = document.getElementById('authCard');
  const dashCard = document.getElementById('dashCard');
  function showAuth(){ authCard.classList.remove('hidden'); dashCard.classList.add('hidden'); }
  function showDash(){ authCard.classList.add('hidden'); dashCard.classList.remove('hidden'); }

  function toDate(x){ if(!x) return null; const d=new Date(x); return isNaN(d)?null:d; }
  function toJalaliStr(d){ d = toDate(d); if(!d) return "—"; const g={gy:d.getFullYear(),gm:d.getMonth()+1,gd:d.getDate()}; const j= jalaali.toJalaali(g.gy,g.gm,g.gd); return `${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`; }
  const star = n => '★'.repeat(n||0);

  function setAssistantSession(u){
    const displayName = (u && (u.name||'').trim()) || '';
    const email = (u && (u.email||'').trim()) || '';
    sessionStorage.setItem('assistantName', displayName);
    sessionStorage.setItem('assistantEmail', email);
    document.getElementById('welcome').textContent = `خوش آمدی ${displayName || email}`;
    const qs = new URLSearchParams({ assistant: encodeURIComponent(displayName || email) }).toString();
    document.getElementById('btnAddNew').href = `index.html?${qs}`;
  }

  document.getElementById('btnLogin').onclick = async ()=>{
    const email = (document.getElementById('loginEmail').value||'').trim();
    const pass  = (document.getElementById('loginPass').value||'').trim();
    const msg   = document.getElementById('loginMsg');
    msg.style.display='block'; msg.className='msg'; msg.textContent='در حال ورود…';
    try{
      const u = await Backendless.UserService.login(email, pass, true);
      setAssistantSession(u);
      showDash();
      resetPaging(); await loadAll();
      msg.className='msg ok'; msg.textContent='ورود موفق.';
    }catch(e){
      msg.className='msg err'; msg.textContent = 'خطا در ورود: ' + (e.message||e);
    }
  };

  document.getElementById('btnSignup').onclick = async ()=>{
    const name  = (document.getElementById('suName').value||'').trim();
    const email = (document.getElementById('suEmail').value||'').trim();
    const pass  = (document.getElementById('suPass').value||'').trim();
    const msg   = document.getElementById('signupMsg');
    msg.style.display='block'; msg.className='msg'; msg.textContent='در حال ثبت‌نام…';
    try{
      if(!name || !email || !pass){ msg.className='msg err'; msg.textContent='نام، ایمیل و رمز لازم است.'; return; }
      const user = new Backendless.User();
      user.name = name; user.email = email; user.password = pass;
      await Backendless.UserService.register(user);
      const u = await Backendless.UserService.login(email, pass, true);
      setAssistantSession(u);
      showDash();
      resetPaging(); await loadAll();
      msg.className='msg ok'; msg.textContent='ثبت‌نام و ورود موفق.';
    }catch(e){
      msg.className='msg err'; msg.textContent = 'خطا در ثبت‌نام: ' + (e.message||e);
    }
  };

  (async function autoLogin(){
    try{
      const u = await Backendless.UserService.getCurrentUser();
      if(u){ setAssistantSession(u); showDash(); resetPaging(); await loadAll(); }
    }catch(_){}
  })();

  document.getElementById('btnLogout').onclick = async ()=>{
    try{ await Backendless.UserService.logout(); }catch(_){}
    sessionStorage.removeItem('assistantName');
    sessionStorage.removeItem('assistantEmail');
    showAuth();
  };

  document.getElementById('btnApply').onclick = ()=>{ resetPaging(); loadAll(); };
  document.getElementById('btnReset').onclick = ()=>{
    document.getElementById('q').value='';
    document.getElementById('city').value='';
    resetPaging(); loadAll();
  };

  let page=0, pageSize=30, cacheAll=[];
  function resetPaging(){ page=0; }
  document.getElementById('prev').onclick=()=>{ if(page>0){ page--; renderList(); } };
  document.getElementById('next').onclick=()=>{ if((page+1)*pageSize<cacheAll.length){ page++; renderList(); } };

  function renderKPI(rows){
    let totalContracts = rows.length;
    let totalAmount = 0;
    let totalPaid = 0;
    let openNewbloods = 0;
    let coinsAll = 0;

    rows.forEach(r=>{
      const inst = Array.isArray(r.instalments) ? r.instalments : [];
      let planPaid = 0, planTotal = 0, allDone = true;

      inst.forEach(ins=>{
        const amount = Number(ins?.amount)||0;
        const status = (ins?.status) || (amount>0 ? 'pending' : 'pending');
        planTotal += amount;
        if(status==='done') planPaid += amount;
        if(status!=='done') allDone = false;
      });

      totalAmount += planTotal;
      totalPaid   += planPaid;
      if(!allDone) openNewbloods += 1;

      coinsAll += Array.isArray(r.coins) ? r.coins.length : 0;
    });

    const remain = Math.max(totalAmount - totalPaid, 0);
    const fmt = n => (Number(n)||0).toLocaleString('fa-IR');
    kpiContracts.textContent = fmt(totalContracts);
    kpiTotal.textContent     = fmt(totalAmount);
    kpiPaid.textContent      = fmt(totalPaid);
    kpiRemain.textContent    = fmt(remain);
    kpiOpen.textContent      = fmt(openNewbloods);
    kpiCoins.textContent     = fmt(coinsAll);
    document.getElementById('kpisWrap').style.display = 'grid';
  }

  async function loadAll(){
    const name = (sessionStorage.getItem('assistantName')||'').trim();
    const email= (sessionStorage.getItem('assistantEmail')||'').trim();
    const idKey= name || email;

    const like = idKey.replace(/'/g,"''");
    const where = `(assistant LIKE '%${like}%') OR (assistants LIKE '%${like}%')`;

    const tb = Backendless.Data.of('Newbloods');
    let offset=0, all=[], chunk=[];
    try{
      do{
        const qb = Backendless.DataQueryBuilder.create()
                    .setWhereClause(where)
                    .setSortBy(['created DESC'])
                    .setPageSize(100)
                    .setOffset(offset);
        chunk = await tb.find(qb);
        all.push(...chunk);
        offset += 100;
      }while(chunk.length===100);

      const needle = idKey;
      all = all.filter(r=>{
        const arr = Array.isArray(r.assistants)&&r.assistants.length
          ? r.assistants
          : (r.assistant ? [r.assistant] : []);
        return arr.some(x => (x||'').toString().includes(needle));
      });

      const q  = (document.getElementById('q').value||'').trim();
      const ct = (document.getElementById('city').value||'').trim();
      if(q){ all = all.filter(r => ((r.name||'').includes(q) || (r.mobile||'').includes(q))); }
      if(ct){ all = all.filter(r => ((r.city||'').includes(ct) || (r.province||'').includes(ct))); }

      cacheAll = all;
      renderList();
      renderKPI(cacheAll);
    }catch(e){
      alert('خطا در بارگذاری داده‌ها: ' + (e.message||e));
    }
  }

  function renderList(){
    const list = document.getElementById('list');
    const rows = cacheAll.slice(page*pageSize,(page+1)*pageSize);
    list.innerHTML='';
    if(!rows.length){
      list.innerHTML='<div class="muted">هنوز نیوبلادی ثبت نشده.</div>';
    }else{
      const myNameOrEmail = (sessionStorage.getItem('assistantName')||sessionStorage.getItem('assistantEmail')||'').trim();

      rows.forEach(r=>{
        const coinsCount = Array.isArray(r.coins) ? r.coins.length : 0;
        const cd = r.course_date ? toJalaliStr(r.course_date) : '—';
        const growthStars = star(+r.growth||0);
        const cityPart = [r.province, r.city].filter(Boolean).join(' / ');
        const badge = r.contract_signed
          ? '<span class="badge badge-ok">قرارداد</span>'
          : '<span class="badge badge-no">بدون قرارداد</span>';

        const assistants = (Array.isArray(r.assistants) && r.assistants.length)
          ? r.assistants.join('، ')
          : (r.assistant || '—');

        const qs = new URLSearchParams({
          objectId: r.objectId,
          assistant: encodeURIComponent(myNameOrEmail)
        }).toString();

        const wrap=document.createElement('div');
        wrap.className='item';
        wrap.innerHTML=`
          <div>
            <div class="line"><b>${r.name||'—'}</b> <span class="muted">(${r.mobile||'—'})</span> ${badge}</div>
            <div class="meta">
              ${cityPart||'—'} | استادیار(ها): ${assistants} | رشد: ${growthStars} | کوین: ${coinsCount} | تاریخ دوره: ${cd}
            </div>
          </div>
          <div class="actions">
            <a href="index.html?${qs}" target="_self">ویرایش</a>
          </div>
        `;
        list.appendChild(wrap);
      });
    }
    document.getElementById('pageInfo').textContent =
      `صفحه ${rows.length ? (page+1) : 0} از ${Math.max(1, Math.ceil(cacheAll.length/pageSize))}`;
  }

  function toCSV(arr){
    if(!arr.length) return '';
    const cols = [...new Set(arr.flatMap(o=>Object.keys(o)))];
    const esc = v => { if(v==null) return ''; const s = typeof v === 'object' ? JSON.stringify(v) : String(v); return `"${s.replace(/"/g,'""')}"`; };
    const head = cols.map(esc).join(',');
    const rows = arr.map(o=> cols.map(c=>esc(o[c])).join(',')).join('\n');
    return head + '\n' + rows;
  }
  function download(filename, text, mime='text/csv;charset=utf-8'){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    URL.revokeObjectURL(url); a.remove();
  }
  document.getElementById('btnExport').onclick = ()=>{
    if(!cacheAll.length){ alert('لیستی برای خروجی وجود ندارد.'); return; }
    const csv = toCSV(cacheAll);
    const fname = `swan_assistant_list_${new Date().toISOString().slice(0,10)}.csv`;
    download(fname, csv);
  };
</script>
</body>
</html>
