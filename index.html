<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>فرم ثبت نیوبلاد - Swan Family</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Backendless SDK -->
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>

  <!-- jQuery + Persian Datepicker (نگه داشته شده برای سازگاری، اما دیگر استفاده نمی‌کنیم) + jalaali-js -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.3/dist/jalaali.min.js"></script>

  <style>
    :root{ --brand:#009688 }
    *{box-sizing:border-box}
    body{font-family:Tahoma,system-ui,sans-serif;background:#f5f5f5;margin:0;padding:0;font-size:17px;color:#111}
    header{background:#222;color:#fff;text-align:center;padding:12px}
    header h1{margin:0;font-size:18px}
    form{background:#fff;max-width:980px;margin:18px auto;padding:18px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    label{display:block;margin-top:12px;font-weight:800;color:#111}
    input,select,textarea{width:100%;padding:1rem;border:1px solid #9ea7ad;border-radius:10px;margin-top:6px;font-size:18px;color:#111;background:#fff}
    input::placeholder, textarea::placeholder{color:#444}
    input:focus, select:focus, textarea:focus{outline:none;border-color:#00796b;box-shadow:0 0 0 3px rgba(0,121,107,.12)}
    textarea{min-height:90px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#555;font-size:.95rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:.8rem 1.2rem;cursor:pointer;font-size:16px}
    button.secondary{background:#607d8b}

    .stars span{font-size:1.6rem;cursor:pointer;color:#c9c9c9}
    .stars .selected{color:#f4c430}

    .installments,.coins-log,.referred{margin-top:6px}
    .installment,.coin-entry,.referred-entry{
      background:#f0f0f0;border-radius:10px;padding:.8rem;display:grid;gap:.5rem;align-items:center;margin:.5rem 0
    }
    /* قسط: تاریخ / مبلغ / فیش / هدف / وضعیت / حذف */
    .installment{grid-template-columns:repeat(6, minmax(140px,1fr))}
    .coin-entry{grid-template-columns:minmax(160px,1fr) minmax(220px,2fr) auto}
    .referred-entry{grid-template-columns:1fr auto}
    .installment>button,.coin-entry>button,.referred-entry>button{background:#e53935}

    .pdate-input{direction:ltr;text-align:center}
    input[type="file"]{width:100%}

    .msg{margin-top:12px;padding:.9rem;border-radius:10px;display:none}
    .ok{background:#e0f7f4;color:#00695c}
    .err{background:#ffebee;color:#c62828}

    .backup-bar{display:none;max-width:980px;margin:0 auto 12px;background:#fff;padding:10px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.06);gap:8px;flex-wrap:wrap;align-items:center}
    .backup-bar small{color:#666}

    #assistantsTags .tag{background:#e8f5e9;color:#1b5e20;padding:6px 10px;border-radius:10px;display:inline-flex;gap:8px;align-items:center;margin:4px 6px 0 0}
    #assistantsTags .tag small{display:block;color:#2e7d32;margin-top:2px}
    #assistantsTags .remove{background:#c8e6c9;border:none;border-radius:8px;padding:0 6px;cursor:pointer}

    /* اعتبارسنجی تاریخِ اشتباه */
    .invalid{border-color:#e53935 !important; background:#ffebee}

    /* سوییچ هدف قسط */
    .seg{display:inline-flex;gap:6px;background:#fff;border:1px solid #cfd8dc;border-radius:10px;padding:4px}
    .seg label{margin:0;font-weight:700}
    .seg input{display:none}
    .seg .opt{padding:6px 10px;border-radius:8px;cursor:pointer;color:#333;border:1px solid transparent}
    .seg input:checked + .opt{background:#e0f7f4;color:#00695c;border-color:#b2dfdb}

    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    @media (max-width:820px){
      .installment{grid-template-columns:1fr}
      .installment>button{width:100%;order:99}
      .coin-entry {
  grid-template-columns: 1fr;   /* همه‌ی ورودی‌ها زیر هم */
}
.coin-entry > button {
  width: 100%; order: 99;       /* دکمه حذف هم بیاد زیر */
}
  </style>
</head>
<body>

<header>
  <h1>فرم ثبت نیوبلاد</h1>
</header>

<!-- نوار بکاپ (ادمین) -->
<div class="backup-bar" id="backupBar">
  <button type="button" class="secondary" onclick="backupJSON()">دانلود بکاپ JSON</button>
  <button type="button" class="secondary" onclick="backupCSV()">دانلود بکاپ CSV</button>
  <small>بکاپ خودکار روزانه با GitHub Actions در ریپو تنظیم می‌شود.</small>
</div>

<form id="newbloodForm">
  <!-- قرارداد -->
  <label style="display:flex;align-items:center;gap:8px">
    <input type="checkbox" id="contract_signed"> قرارداد امضا شده
  </label>

  <!-- استادیاران -->
  <label>استادیاران</label>
  <div id="assistantsTags" style="display:flex;gap:6px;flex-wrap:wrap"></div>

  <!-- انتخاب از کاربران ثبت‌نام‌شده + حفظ ورودی دستی قبلی -->
  <div style="display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap">
    <input type="text" id="assistantSearch" placeholder="جستجو: نام یا ایمیل…" style="flex:1;min-width:230px" oninput="filterAssistantOptions(this.value)">
    <select id="assistantSelect" style="flex:1;min-width:230px">
      <option value="">انتخاب از کاربران…</option>
    </select>
    <button type="button" class="secondary" onclick="addAssistantFromSelect()">+ افزودن</button>

    <!-- ورودی دستی قبلی (حذف نشده) -->
    <input type="text" id="assistantInput" placeholder="(اختیاری) نام استادیار به صورت دستی" style="flex:1;min-width:230px">
    <button type="button" class="secondary" onclick="addAssistant()">+ افزودن دستی</button>
  </div>
  <small class="muted">نکته: برای اتصال مطمئن، لطفاً استادیار را از کاربران انتخاب کنید. ورودی دستی برای سازگاری قبلی نگه داشته شده است. اولین استادیار به‌عنوان فیلد میراثی «assistant» ذخیره می‌شود.</small>

  <div class="row">
    <div>
      <label>نام و نام خانوادگی</label>
      <input type="text" name="name" required>
    </div>
    <div>
      <label>موبایل</label>
      <input type="tel" name="mobile" required>
    </div>
  </div>

  <div class="row">
    <div>
      <label>اینستاگرام</label>
      <input type="text" name="instagram" placeholder="@username">
    </div>
    <div>
      <label>وضعیت تأهل</label>
      <select name="marital_status">
        <option value="">انتخاب کنید</option>
        <option value="single">مجرد</option>
        <option value="married">متأهل</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label>شغل اول</label>
      <input type="text" name="job1">
    </div>
    <div>
      <label>شغل دوم</label>
      <input type="text" name="job2">
    </div>
  </div>

  <label>سابقهٔ فعالیت ماساژ</label>
  <textarea name="massage_experience" placeholder="مختصر توضیح دهید..."></textarea>

  <label>مهارت‌هایی که به کار تیم سوان کمک می‌کند</label>
  <textarea name="skills" placeholder="مثلاً: عکاسی، تدوین، تدریس، مدیریت شبکه‌های اجتماعی و..."></textarea>

  <label>نحوهٔ آشنایی با خانوادهٔ سوان</label>
  <textarea name="how_met" placeholder="مثلاً: معرفی دوست، اینستاگرام، شرکت در رویداد و..."></textarea>

  <!-- علاقه‌مندی‌ها -->
  <label>علاقه‌مندی‌ها</label>
  <div class="row">
    <label><input type="checkbox" name="interests" value="anatomy"> آناتومی</label>
    <label><input type="checkbox" name="interests" value="ayurveda"> آیورودا</label>
    <label><input type="checkbox" name="interests" value="marketing"> بازاریابی</label>
  </div>

  <div class="row">
    <div>
      <label>تاریخ تولد (شمسی) — دستی وارد کنید</label>
      <input type="text" id="birthdate_j" class="pdate-input" placeholder="۱۴۰۴/۰۱/۱۵">
    </div>
    <div>
      <label>تاریخ دوره (شمسی) — دستی وارد کنید</label>
      <input type="text" id="course_date_j" class="pdate-input" placeholder="۱۴۰۴/۰۲/۲۰">
    </div>
  </div>

  <div class="row">
    <div>
      <label>محل دوره</label>
      <input type="text" name="course_location">
    </div>
    <div>
      <label>معرف / هماهنگ‌کننده</label>
      <input type="text" name="referrer">
    </div>
  </div>

  <div class="row">
    <div>
      <label>استان</label>
      <select name="province" id="province"></select>
    </div>
    <div>
      <label>شهر</label>
      <input type="text" name="city">
    </div>
  </div>

  <label>پیش‌پرداخت (تومان)</label>
  <input type="number" name="prepayment" min="0" step="1">

  <label>سطح رشد</label>
  <div class="stars" id="growthStars">
    <span data-val="1">★</span>
    <span data-val="2">★</span>
    <span data-val="3">★</span>
    <span data-val="4">★</span>
    <span data-val="5">★</span>
  </div>
  <input type="hidden" name="growth" id="growthVal" value="0">

  <!-- اقساط -->
  <label>اقساط <span class="muted">(تاریخ را دستی وارد کنید؛ در صورت اشتباه قرمز می‌شود)</span></label>
  <div class="installments" id="instContainer"></div>
  <button type="button" class="secondary" onclick="addInstallment()">+ افزودن قسط</button>

  <!-- سوان کوین -->
  <label>سوان کوین</label>
  <div class="coins-log" id="coinsContainer"></div>
  <button type="button" class="secondary" onclick="addCoin()">+ افزودن کوین</button>

  <label>نیوبلادهایی که معرفی کرده</label>
  <div class="referred" id="refContainer"></div>
  <button type="button" class="secondary" onclick="addReferred()">+ افزودن نام معرفی‌شده</button>

  <label>یادداشت</label>
  <textarea name="notes" placeholder="توضیحات تکمیلی..."></textarea>

  <div class="actions">
    <button type="submit" id="submitBtn">ثبت</button>
    <a class="secondary" href="/assistant" style="text-decoration:none;padding:.8rem 1.2rem;border-radius:10px;color:#fff">بازگشت به پنل استادیار</a>
  </div>

  <div id="msg" class="msg"></div>
</form>

<script>
  // ===== تنظیمات ادمین برای نمایش بکاپ =====
  const ADMIN_NAME  = "جواد مرتضوی";
  const ADMIN_EMAIL = "admin@swanfamily.app";

  // ===== Backendless =====
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  (async function showBackupIfAdmin(){
    try{
      const u = await Backendless.UserService.getCurrentUser();
      const isAdmin = !!u && ((u.name||"")===ADMIN_NAME || (u.email||"")===ADMIN_EMAIL);
      if(isAdmin){ document.getElementById('backupBar').style.display = 'flex'; }
    }catch(_){}
  })();

  // ===== استان‌ها (مرتب با الفبا) =====
  const IRAN_PROVINCES = [
    {code:"EAZ",name:"آذربایجان شرقی"},{code:"WAZ",name:"آذربایجان غربی"},{code:"ARW",name:"اردبیل"},
    {code:"ESF",name:"اصفهان"},{code:"ALB",name:"البرز"},{code:"ILM",name:"ایلام"},
    {code:"BHR",name:"بوشهر"},{code:"TEH",name:"تهران"},{code:"CHB",name:"چهارمحال و بختیاری"},
    {code:"BKH",name:"خراسان جنوبی"},{code:"KHR",name:"خراسان رضوی"},{code:"BKN",name:"خراسان شمالی"},
    {code:"KHU",name:"خوزستان"},{code:"ZNJ",name:"زنجان"},{code:"SMN",name:"سمنان"},
    {code:"SBN",name:"سیستان و بلوچستان"},{code:"FAR",name:"فارس"},{code:"QAZ",name:"قزوین"},
    {code:"QOM",name:"قم"},{code:"KRM",name:"کرمان"},{code:"KRH",name:"کرمانشاه"},
    {code:"KBD",name:"کهگیلویه و بویراحمد"},{code:"GZN",name:"گلستان"},{code:"GLN",name:"گیلان"},
    {code:"LRS",name:"لرستان"},{code:"MZN",name:"مازندران"},{code:"MKZ",name:"مرکزی"},
    {code:"HRM",name:"هرمزگان"},{code:"HMD",name:"همدان"},{code:"YZD",name:"یزد"}
  ].sort((a,b)=> a.name.localeCompare(b.name,'fa'));

  function seedProvinces(selected){
    const sel = document.getElementById('province');
    sel.innerHTML = `<option value="">انتخاب استان…</option>` +
      IRAN_PROVINCES.map(p=> `<option value="${p.name}" ${selected===p.name?'selected':''}>${p.name}</option>`).join('');
  }
  seedProvinces('');

  // ===== تاریخ دستی + اعتبارسنجی =====
  function fa2en(str){ return String(str||'').replace(/[۰-۹]/g, d=> '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)); }
  function isValidJalaliStr(s){
    if(!s) return true;
    const m = fa2en(s.trim()).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
    if(!m) return false;
    const jy=+m[1], jm=+m[2], jd=+m[3];
    if(!(window.jalaali && jalaali.isValidJalaaliDate)) return jm>=1 && jm<=12 && jd>=1 && jd<=31;
    return jalaali.isValidJalaaliDate(jy, jm, jd);
  }
  function markValidity(el){
    const ok = isValidJalaliStr(el.value);
    el.classList.toggle('invalid', !ok);
    return ok;
  }
  function jalaliStrToDate(str){
    if(!str) return null;
    const s = fa2en(String(str).trim());
    const m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
    if(!m) return null;
    const jy=+m[1], jm=+m[2], jd=+m[3];
    if(jalaali.isValidJalaaliDate && !jalaali.isValidJalaaliDate(jy,jm,jd)) return null;
    const g = window.jalaali.toGregorian(jy, jm, jd);
    return new Date(g.gy, g.gm-1, g.gd);
  }
  function toJalaliStr(d){
    if(!d) return '';
    const date = new Date(d);
    if(isNaN(date)) return '';
    const g={gy:date.getFullYear(), gm:date.getMonth()+1, gd:date.getDate()};
    const j= jalaali.toJalaali(g.gy,g.gm,g.gd);
    return `${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
  }
  ['birthdate_j','course_date_j'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('input', ()=>{ el.value = fa2en(el.value); markValidity(el); saveDraft(); });
    el.addEventListener('blur', ()=> markValidity(el));
  });

  // ===== ستاره‌های رشد =====
  (function initStars(){
    const stars = document.querySelectorAll('#growthStars span');
    const out = document.getElementById('growthVal');
    stars.forEach(s=>{
      s.onclick=()=>{
        const v = +s.dataset.val;
        out.value = v;
        stars.forEach((el,i)=> el.classList.toggle('selected', i < v));
        saveDraft();
      };
    });
  })();

  // ===== انتخاب استادیار از کاربران (به‌علاوه ورودی دستی قبلی) =====
  let ALL_USERS = []; // {objectId,name,email}
  let assistantsEmails = new Set(); // ایمیل‌های انتخاب‌شده
  let assistantsNames  = new Set(); // نام‌های دستی/نمایشی

  async function loadAllUsers(){
    try{
      const Users = Backendless.Data.of('Users');
      let off=0, chunk=[];
      ALL_USERS = [];
      do{
        const qb = Backendless.DataQueryBuilder.create()
                 .setPageSize(100).setOffset(off)
                 .setProperties(['objectId','name','email'])
                 .setSortBy(['name ASC']);
        chunk = await Users.find(qb);
        ALL_USERS.push(...chunk);
        off += 100;
      }while(chunk.length===100);
      seedAssistantSelect(ALL_USERS);
    }catch(e){ console.warn('load users failed', e); }
  }
  function seedAssistantSelect(arr){
    const sel = document.getElementById('assistantSelect');
    sel.innerHTML = `<option value="">انتخاب از کاربران…</option>` +
      arr.map(u=>{
        const disp = `${(u.name||'بدون‌نام')} — ${u.email||''}`;
        return `<option value="${u.email||''}" data-name="${u.name||''}">${disp}</option>`;
      }).join('');
  }
  function filterAssistantOptions(q){
    q = (q||'').trim().toLowerCase();
    const filtered = !q ? ALL_USERS : ALL_USERS.filter(u=>{
      return (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q);
    });
    seedAssistantSelect(filtered);
  }
  function renderAssistantTags(){
    const box = document.getElementById('assistantsTags');
    box.innerHTML = '';

    // نمایش ایمیل‌دارها
    assistantsEmails.forEach(email=>{
      const u = ALL_USERS.find(x=> (x.email||'')===email);
      const name = u?.name || email;
      const tag = document.createElement('div');
      tag.className='tag';
      tag.innerHTML = `
        <div style="display:flex;gap:6px;align-items:center">
          <b>${name}</b>
          <button type="button" class="remove" onclick="removeAssistant('${email}')">×</button>
        </div>
        <small>${email}</small>
      `;
      box.appendChild(tag);
    });

    // نمایش نام‌های دستی که ایمیل ندارند
    assistantsNames.forEach(name=>{
      // اگر این نام با ایمیل نمایش داده شده، دوباره نشان نده
      const existsByName = [...assistantsEmails].some(em=>{
        const u = ALL_USERS.find(x=> (x.email||'')===em);
        return (u?.name||'') === name;
      });
      if(existsByName) return;
      const tag = document.createElement('div');
      tag.className='tag';
      tag.innerHTML = `
        <div style="display:flex;gap:6px;align-items:center">
          <b>${name}</b>
          <button type="button" class="remove" onclick="removeAssistantByName('${name}')">×</button>
        </div>
      `;
      box.appendChild(tag);
    });
  }
  function addAssistantFromSelect(){
    const sel = document.getElementById('assistantSelect');
    const email = sel.value;
    if(!email) return;
    const name  = sel.selectedOptions[0]?.dataset?.name || '';
    assistantsEmails.add(email);
    if(name) assistantsNames.add(name);
    renderAssistantTags();
    saveDraft();
  }
  // ورودی دستی (حذف نشده)
  function addAssistant(nameOpt){
    const inp = document.getElementById('assistantInput');
    const name = (nameOpt || inp.value || '').trim();
    if(!name) return;
    assistantsNames.add(name);
    inp.value = '';
    renderAssistantTags();
    saveDraft();
  }
  function removeAssistant(email){
    assistantsEmails.delete(email);
    renderAssistantTags();
    saveDraft();
  }
  function removeAssistantByName(name){
    assistantsNames.delete(name);
    renderAssistantTags();
    saveDraft();
  }
  (function seedAssistantFromURL(){
    const a = new URLSearchParams(location.search).get('assistant');
    if(a && a.includes('@')) assistantsEmails.add(decodeURIComponent(a).trim());
    renderAssistantTags();
  })();

  // ===== Helpers =====
  const toNumber = v => (v===''||v==null ? null : Number(v));
  async function uploadReceipt(file){
    const safe = (file.name||'receipt').replace(/\s+/g,'_');
    const fname = `${Date.now()}_${safe}`;
    const res = await Backendless.Files.upload(file, `receipts/${fname}`, true);
    return res?.fileURL || res?.url || (typeof res === 'string' ? res : null);
  }

  // ===== اقساط (target: assistant|swan) =====
  function addInstallment(rowData){
    const div=document.createElement('div');
    div.className='installment';
    const uid = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    const targetVal = rowData?.target || 'assistant';

    div.innerHTML=`
      <input type="text" class="pdate-input inst-date" placeholder="تاریخ قسط (شمسی) مثلا ۱۴۰۴/۰۶/۰۱">
      <input type="number" class="inst-amount" placeholder="مبلغ (تومان)" min="0" step="1">
      <div>
        <input type="file" class="inst-file" accept="image/*,application/pdf">
        <div class="muted curr-link" style="margin-top:4px"></div>
      </div>

      <div>
        <div class="seg">
          <label>
            <input type="radio" name="inst-target-${uid}" value="assistant" ${targetVal==='assistant'?'checked':''}>
            <span class="opt">استادیار</span>
          </label>
          <label>
            <input type="radio" name="inst-target-${uid}" value="swan" ${targetVal==='swan'?'checked':''}>
            <span class="opt">سوان</span>
          </label>
        </div>
      </div>

      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="inst-paid"> پرداخت شد</label>
      <button type="button" onclick="this.parentNode.remove(); saveDraft()">حذف</button>`;

    document.getElementById('instContainer').appendChild(div);

    const d = div.querySelector('.inst-date');
    const amt = div.querySelector('.inst-amount');
    const paid = div.querySelector('.inst-paid');

    d.addEventListener('input', ()=>{ d.value = fa2en(d.value); markValidity(d); saveDraft(); });
    d.addEventListener('blur', ()=> markValidity(d));
    amt.addEventListener('input', saveDraft);
    paid.addEventListener('change', saveDraft);

    div.querySelectorAll(`input[name="inst-target-${uid}"]`).forEach(r=>{
      r.addEventListener('change', saveDraft);
    });

    if(rowData){
      if(rowData.date) d.value = toJalaliStr(rowData.date);
      if(rowData.amount!=null) amt.value = rowData.amount;
      if(rowData.status==='done') paid.checked = true;
      if(rowData.receipt_url){
        div.dataset.currentUrl = rowData.receipt_url;
        div.querySelector('.curr-link').innerHTML = `<a href="${rowData.receipt_url}" target="_blank">مشاهده فیش فعلی</a>`;
      }
    }
  }

  function addCoin(rowData){
    const div=document.createElement('div');
    div.className='coin-entry';
    div.innerHTML=`
      <input type="text" class="pdate-input coin-date" placeholder="تاریخ کوین (شمسی) مثلا ۱۴۰۴/۰۶/۰۱">
      <input type="text" class="coin-note" placeholder="توضیح (اختیاری)">
      <button type="button" onclick="this.parentNode.remove(); saveDraft()">حذف</button>`;
    document.getElementById('coinsContainer').appendChild(div);

    const d = div.querySelector('.coin-date');
    const note = div.querySelector('.coin-note');
    d.addEventListener('input', ()=>{ d.value = fa2en(d.value); markValidity(d); saveDraft(); });
    d.addEventListener('blur', ()=> markValidity(d));
    note.addEventListener('input', saveDraft);

    if(rowData){
      if(rowData.date) d.value = toJalaliStr(rowData.date);
      if(rowData.note) note.value = rowData.note;
    }
  }

  function addReferred(nameVal){
    const div=document.createElement('div');
    div.className='referred-entry';
    div.innerHTML=`
      <input type="text" class="ref-name" placeholder="نام نیوبلاد معرفی‌شده">
      <button type="button" onclick="this.parentNode.remove(); saveDraft()">حذف</button>`;
    document.getElementById('refContainer').appendChild(div);
    const inp = div.querySelector('.ref-name');
    if(nameVal) inp.value = nameVal;
    inp.addEventListener('input', saveDraft);
  }

  // ===== حالت ویرایش =====
  let currentObjectId = new URLSearchParams(location.search).get('objectId') || null;

  function applyAssistantsFromRecord(rec){
    const emails = Array.isArray(rec.assistants_emails) ? rec.assistants_emails : [];
    const names  = Array.isArray(rec.assistants_names)  ? rec.assistants_names  : [];

    if(emails.length){
      assistantsEmails = new Set(emails);
    }
    if(names.length){
      assistantsNames = new Set(names);
    }else{
      // رکورد قدیمی: فقط اسم‌ها
      const list = (Array.isArray(rec.assistants) && rec.assistants.length)
        ? rec.assistants
        : (rec.assistant ? [rec.assistant] : []);
      list.forEach(n=> assistantsNames.add(n));
    }
    renderAssistantTags();
  }

  if(currentObjectId){
    (async function loadExisting(){
      try{
        const rec = await Backendless.Data.of('Newbloods').findById(currentObjectId);

        document.getElementById('contract_signed').checked = !!rec.contract_signed;

        applyAssistantsFromRecord(rec);

        document.querySelector('[name="name"]').value = rec.name||'';
        document.querySelector('[name="mobile"]').value = rec.mobile||'';
        document.querySelector('[name="instagram"]').value = rec.instagram||'';
        document.querySelector('[name="marital_status"]').value = rec.marital_status||'';
        document.querySelector('[name="job1"]').value = rec.job1||'';
        document.querySelector('[name="job2"]').value = rec.job2||'';
        document.querySelector('[name="massage_experience"]').value = rec.massage_experience||'';
        document.querySelector('[name="skills"]').value = rec.skills||'';
        document.querySelector('[name="how_met"]').value = rec.how_met||'';

        document.getElementById('birthdate_j').value = toJalaliStr(rec.birthdate);
        document.getElementById('course_date_j').value = toJalaliStr(rec.course_date);

        document.querySelector('[name="course_location"]').value = rec.course_location||'';
        document.querySelector('[name="referrer"]').value = rec.referrer||'';

        seedProvinces(rec.province||'');
        document.querySelector('[name="city"]').value = rec.city||'';
        document.querySelector('[name="prepayment"]').value = rec.prepayment||'';

        const gv = +rec.growth||0;
        document.getElementById('growthVal').value = gv;
        document.querySelectorAll('#growthStars span').forEach((s,i)=> s.classList.toggle('selected', i < gv));

        (Array.isArray(rec.instalments) ? rec.instalments : []).forEach(addInstallment);
        (Array.isArray(rec.coins) ? rec.coins : []).forEach(addCoin);
        (Array.isArray(rec.referred_people) ? rec.referred_people : []).forEach(addReferred);

        const ints = Array.isArray(rec.interests) ? rec.interests : [];
        ints.forEach(v=>{
          const el = document.querySelector(`input[name="interests"][value="${v}"]`);
          if(el) el.checked = true;
        });

        // اعتبارسنجی اولیه تاریخ‌ها
        ['birthdate_j','course_date_j'].forEach(id=> markValidity(document.getElementById(id)));
        document.querySelectorAll('.inst-date,.coin-date').forEach(el=> markValidity(el));

      }catch(e){
        alert('خطا در بارگذاری رکورد: ' + (e.message||e));
      }
    })();

    document.getElementById('submitBtn').textContent = 'به‌روزرسانی';
  }else{
    seedProvinces('');
  }

  // ===== اتوسیو پیش‌نویس =====
  const DRAFT_KEY = 'swan_newblood_draft';
  function collectFormData(){
    const fd = new FormData(document.getElementById('newbloodForm'));
    const data = {};
    fd.forEach((v,k)=> data[k]=v);

    data.contract_signed = document.getElementById('contract_signed').checked;
    data.birthdate   = document.getElementById('birthdate_j').value;
    data.course_date = document.getElementById('course_date_j').value;
    data.growth = document.getElementById('growthVal').value;

    data.interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(i=>i.value);

    // استادیارها
    data.assistants_emails = Array.from(assistantsEmails);
    data.assistants_names  = Array.from(assistantsNames);
    // سازگاری قبلی
    data.assistants = data.assistants_names.length ? data.assistants_names
                     : (Array.isArray(data.assistants_emails) ? data.assistants_emails : []);
    data.assistant  = data.assistants_names[0] || data.assistants_emails[0] || '';

    // اقساط
    data.instalments = Array.from(document.querySelectorAll('.installment')).map(row=>{
      const date = row.querySelector('.inst-date').value;
      const amount = row.querySelector('.inst-amount').value;
      const paid = row.querySelector('.inst-paid').checked;
      const receipt_url = row.dataset.currentUrl || null;
      const targetEl = row.querySelector('input[name^="inst-target-"]:checked');
      const target = targetEl ? targetEl.value : 'assistant';
      return { date, amount, status: (paid ? 'done' : 'pending'), receipt_url, target };
    });

    // کوین‌ها
    data.coins = Array.from(document.querySelectorAll('.coin-entry')).map(row=>{
      const date = row.querySelector('.coin-date').value;
      const note = row.querySelector('.coin-note').value || '';
      return { date, note };
    });

    data.referred_people = Array.from(document.querySelectorAll('.ref-name')).map(i=>i.value.trim()).filter(Boolean);

    return data;
  }
  function saveDraft(){ try{ if(!currentObjectId){ localStorage.setItem(DRAFT_KEY, JSON.stringify(collectFormData())); } }catch(_){} }
  function restoreDraftIfAny(){
    if(currentObjectId) return;
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      document.getElementById('contract_signed').checked = !!d.contract_signed;
      if(Array.isArray(d.assistants_emails)) assistantsEmails = new Set(d.assistants_emails);
      if(Array.isArray(d.assistants_names))  assistantsNames  = new Set(d.assistants_names);
      renderAssistantTags();

      const setVal = (name,val)=>{ const el=document.querySelector(`[name="${name}"]`); if(el && val!=null) el.value = val; };
      setVal('name', d.name); setVal('mobile', d.mobile); setVal('instagram', d.instagram);
      setVal('marital_status', d.marital_status); setVal('job1', d.job1); setVal('job2', d.job2);
      setVal('massage_experience', d.massage_experience); setVal('skills', d.skills); setVal('how_met', d.how_met);

      document.getElementById('birthdate_j').value = d.birthdate||'';
      document.getElementById('course_date_j').value = d.course_date||'';

      setVal('course_location', d.course_location); setVal('referrer', d.referrer);

      seedProvinces(d.province||'');
      setVal('city', d.city); setVal('prepayment', d.prepayment);

      document.getElementById('growthVal').value = +d.growth||0;
      document.querySelectorAll('#growthStars span').forEach((s,i)=> s.classList.toggle('selected', i < (+d.growth||0)));

      (Array.isArray(d.instalments)?d.instalments:[]).forEach(it=>{
        addInstallment({
          date: jalaliStrToDate(it.date),
          amount: Number(it.amount)||null,
          status: it.status==='done'?'done':'pending',
          receipt_url: it.receipt_url||null,
          target: it.target==='swan' ? 'swan' : 'assistant'
        });
      });
      (Array.isArray(d.coins)?d.coins:[]).forEach(c=>{
        addCoin({ date: jalaliStrToDate(c.date), note: c.note||'' });
      });
      (Array.isArray(d.referred_people)?d.referred_people:[]).forEach(addReferred);

      (Array.isArray(d.interests)?d.interests:[]).forEach(v=>{
        const el = document.querySelector(`input[name="interests"][value="${v}"]`); if(el) el.checked = true;
      });

      // اعتبارسنجی اولیه
      ['birthdate_j','course_date_j'].forEach(id=> markValidity(document.getElementById(id)));
      document.querySelectorAll('.inst-date,.coin-date').forEach(el=> markValidity(el));

    }catch(_){}
  }
  document.getElementById('newbloodForm').addEventListener('input', saveDraft);
  document.getElementById('newbloodForm').addEventListener('change', saveDraft);
  window.addEventListener('beforeunload', saveDraft);
  // بارگذاری کاربران برای Select
  loadAllUsers();
  // بازیابی پیش‌نویس (در صورت فرم جدید)
  restoreDraftIfAny();

  // ===== Submit =====
  document.getElementById('newbloodForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const msg = document.getElementById('msg');
    msg.style.display='block'; msg.className='msg'; msg.textContent='در حال ذخیره...';

    // اعتبارسنجی تاریخ‌ها
    const allDateInputs = [
      document.getElementById('birthdate_j'),
      document.getElementById('course_date_j'),
      ...document.querySelectorAll('.inst-date'),
      ...document.querySelectorAll('.coin-date')
    ];
    let okAll = true;
    allDateInputs.forEach(el=>{ if(!markValidity(el)) okAll = false; });
    if(!okAll){
      msg.className='msg err'; msg.textContent='❌ فرمت تاریخ را اصلاح کنید (فیلدهای قرمز).';
      return;
    }

    const fd = new FormData(e.target);
    const data = {};
    fd.forEach((v,k)=> data[k]=v);

    data.contract_signed = document.getElementById('contract_signed').checked;

    data.birthdate   = jalaliStrToDate(document.getElementById('birthdate_j').value);
    data.course_date = jalaliStrToDate(document.getElementById('course_date_j').value);

    data.growth = toNumber(document.getElementById('growthVal').value) || 0;
    data.prepayment = toNumber(data.prepayment);

    data.interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(i=>i.value);

    // استادیارها (ایمیل + نام) + سازگاری
    data.assistants_emails = Array.from(assistantsEmails);
    data.assistants_names  = Array.from(assistantsNames);
    data.assistants = data.assistants_names.length ? data.assistants_names
                   : (Array.isArray(data.assistants_emails) ? data.assistants_emails : []);
    data.assistant  = data.assistants_names[0] || data.assistants_emails[0] || '';

    // اقساط
    const instRows = Array.from(document.querySelectorAll('.installment'));
    const instPromises = instRows.map(async row=>{
      const date = jalaliStrToDate(row.querySelector('.inst-date').value);
      const amount = toNumber(row.querySelector('.inst-amount').value);
      const paid = row.querySelector('.inst-paid').checked;
      const targetEl = row.querySelector('input[name^="inst-target-"]:checked');
      const target = targetEl ? targetEl.value : 'assistant';
      const file = row.querySelector('.inst-file')?.files?.[0];
      let receipt_url = row.dataset.currentUrl || null;
      if(file){ try{ receipt_url = await uploadReceipt(file); }catch(e){ console.warn('upload failed',e); } }
      return (date || amount || receipt_url || paid)
        ? { date, amount, status: (paid?'done':'pending'), receipt_url, target }
        : null;
    });
    data.instalments = (await Promise.all(instPromises)).filter(Boolean);

    // کوین‌ها
    data.coins = Array.from(document.querySelectorAll('.coin-entry')).map(row=>{
      const date = jalaliStrToDate(row.querySelector('.coin-date').value);
      const note = (row.querySelector('.coin-note').value||'').trim();
      return date ? { date, note } : null;
    }).filter(Boolean);

    // معرفی‌شده‌ها
    data.referred_people = Array.from(document.querySelectorAll('.ref-name'))
      .map(i=>i.value.trim()).filter(Boolean);

    try{
      if(currentObjectId){ data.objectId = currentObjectId; }
      await Backendless.Data.of('Newbloods').save(data);
      msg.className='msg ok'; msg.textContent = currentObjectId ? '✅ اطلاعات به‌روزرسانی شد.' : '✅ اطلاعات ذخیره شد.';

      try{ localStorage.removeItem(DRAFT_KEY); }catch(_){}

      if(!currentObjectId){
        e.target.reset();
        document.getElementById('birthdate_j').value='';
        document.getElementById('course_date_j').value='';
        document.getElementById('instContainer').innerHTML='';
        document.getElementById('coinsContainer').innerHTML='';
        document.getElementById('refContainer').innerHTML='';
        document.querySelectorAll('#growthStars span').forEach(s=>s.classList.remove('selected'));
        document.getElementById('growthVal').value=0;
        assistantsEmails = new Set();
        assistantsNames  = new Set();
        renderAssistantTags();
        seedProvinces('');
      }
    }catch(err){
      msg.className='msg err'; msg.textContent='❌ خطا در ذخیره: ' + (err.message||err);
    }
  });

  // ===== بکاپ دستی =====
  async function fetchAllNewbloods(){ const store = []; let page = 0, pageSize = 100, chunk = []; const tb = Backendless.Data.of('Newbloods'); do{ const qb = Backendless.DataQueryBuilder.create().setPageSize(pageSize).setOffset(page*pageSize).setSortBy(['created DESC']); chunk = await tb.find(qb); store.push(...chunk); page++; }while(chunk.length === pageSize); return store; }
  function download(filename, text, mime='application/json'){ const blob = new Blob([text], {type:mime}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove(); }
  function toCSV(arr){ if(!arr.length) return ''; const cols = [...new Set(arr.flatMap(o=>Object.keys(o)))]; const esc = v => { if(v==null) return ''; const s = typeof v === 'object' ? JSON.stringify(v) : String(v); return `"${s.replace(/"/g,'""')}"`; }; const head = cols.map(esc).join(','); const rows = arr.map(o=> cols.map(c=>esc(o[c])).join(',')).join('\n'); return head + '\n' + rows; }
  async function backupJSON(){ try{ const data = await fetchAllNewbloods(); const fname = `swanfamily_newbloods_${new Date().toISOString().slice(0,10)}.json`; download(fname, JSON.stringify(data, null, 2), 'application/json'); }catch(e){ alert('خطا در بکاپ JSON'); } }
  async function backupCSV(){ try{ const data = await fetchAllNewbloods(); const fname = `swanfamily_newbloods_${new Date().toISOString().slice(0,10)}.csv`; download(fname, toCSV(data), 'text/csv;charset=utf-8'); }catch(e){ alert('خطا در بکاپ CSV'); } }
</script>

</body>
</html>

