<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>فرم ثبت نیوبلاد - Swan Family (نسخه Patch با تغییرات درخواستی)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Backendless SDK -->
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>

  <!-- jQuery + Persian Datepicker (شمسی) + jalaali-js -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
  <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.3/dist/jalaali.min.js"></script>

  <style>
    :root{ --brand:#009688 }
    *{box-sizing:border-box}
    body{font-family:Tahoma,system-ui,sans-serif;background:#f5f5f5;margin:0;padding:0}
    header{background:#222;color:#fff;text-align:center;padding:12px}
    header h1{margin:0;font-size:18px}
    form{background:#fff;max-width:1100px;margin:18px auto;padding:18px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    label{display:block;margin-top:12px;font-weight:700}
    input,select,textarea{width:100%;padding:.6rem;border:1px solid #dedede;border-radius:10px;margin-top:6px}
    textarea{min-height:90px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#666;font-size:.9rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:.65rem 1.2rem;cursor:pointer}
    button.secondary{background:#607d8b}

    .stars span{font-size:1.6rem;cursor:pointer;color:#c9c9c9}
    .stars .selected{color:#f4c430}

    .installments,.coins-log,.referred{margin-top:6px}
    .installment,.coin-entry,.referred-entry{
      background:#f0f0f0;border-radius:10px;padding:.7rem;display:grid;gap:.5rem;align-items:center;margin:.4rem 0
    }
    .installment{grid-template-columns:repeat(6, minmax(160px,1fr))} /* ستون‌های بیشتر برای فیلدهای جدید */
    .coin-entry{grid-template-columns:minmax(160px,1fr) minmax(220px,2fr) auto}
    .referred-entry{grid-template-columns:1fr auto}
    .installment>button,.coin-entry>button,.referred-entry>button{background:#e53935}

    .pdate-input{direction:ltr;text-align:center}
    input[type="file"]{width:100%}

    .msg{margin-top:12px;padding:.7rem;border-radius:10px;display:none}
    .ok{background:#e0f7f4;color:#00695c}
    .err{background:#ffebee;color:#c62828}

    /* نوار بکاپ فقط برای ادمین؛ پیش‌فرض پنهان */
    .backup-bar{display:none;max-width:1100px;margin:0 auto 12px;background:#fff;padding:10px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.06);gap:8px;flex-wrap:wrap;align-items:center}
    .backup-bar small{color:#666}

    /* تگ‌های استادیاران */
    #assistantsTags span{background:#e8f5e9;color:#1b5e20;padding:4px 8px;border-radius:10px;display:inline-flex;gap:6px;align-items:center}

    /* NEW: پنل KPI بالای فرم */
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-width:1100px;margin:12px auto}
    .kpi .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .kpi .card h3{margin:0 0 6px 0;font-size:14px;color:#607d8b}
    .kpi .card .num{font-size:22px;font-weight:800}

    /* NEW: پنل ادمین برای فیلتر/گزارش */
    .admin-panel{display:none;max-width:1100px;margin:12px auto;background:#fff;padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .admin-panel h2{margin:0 0 8px 0;font-size:16px}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border:1px solid #eee;padding:8px;font-size:13px}

    @media (max-width:900px){ .row{grid-template-columns:1fr} .kpi{grid-template-columns:1fr 1fr} .grid-4{grid-template-columns:1fr 1fr} }
    @media (max-width:700px){
      .installment,.coin-entry,.referred-entry{grid-template-columns:1fr}
      .installment>button,.coin-entry>button,.referred-entry>button{width:100%;order:99}
      .kpi{grid-template-columns:1fr}
      .grid-4{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

<header>
  <h1>فرم ثبت نیوبلاد</h1>
</header>

<!-- NEW: پنل KPI (خلاصه‌ی وضعیت این رکورد/کاربر) -->
<section class="kpi" id="kpiPanel" style="display:none">
  <div class="card"><h3>سوان‌کوین این پرونده</h3><div class="num" id="kpiCoins">0</div></div>
  <div class="card"><h3>مجموع اقساط</h3><div class="num" id="kpiInstCount">0</div></div>
  <div class="card"><h3>پرداخت‌شده</h3><div class="num" id="kpiPaid">0</div></div>
  <div class="card"><h3>باقی‌مانده</h3><div class="num" id="kpiRemain">0</div></div>
</section>

<!-- NEW: پنل گزارش ادمین -->
<section class="admin-panel" id="adminPanel">
  <h2>داشبورد مدیریت (Leader/Admin)</h2>
  <div class="grid-4">
    <select id="filterProvince">
      <option value="">همهٔ استان‌ها</option>
    </select>
    <input type="text" id="filterAssistant" placeholder="نام استادیار">
    <input type="text" id="filterFromJ" class="pdate-input" placeholder="از تاریخ (شمسی)">
    <input type="text" id="filterToJ" class="pdate-input" placeholder="تا تاریخ (شمسی)">
  </div>
  <div class="actions" style="margin-top:10px">
    <button type="button" class="secondary" id="btnRunReport">اجرای گزارش</button>
    <button type="button" class="secondary" id="btnExportReport">خروجی CSV</button>
  </div>
  <div id="adminTableWrap"></div>
</section>

<!-- نوار بکاپ (فقط وقتی ادمین لاگین است نمایش داده می‌شود) -->
<div class="backup-bar" id="backupBar">
  <button type="button" class="secondary" onclick="backupJSON()">دانلود بکاپ JSON</button>
  <button type="button" class="secondary" onclick="backupCSV()">دانلود بکاپ CSV</button>
  <small>بکاپ خودکار روزانه با GitHub Actions در ریپو تنظیم می‌شود.</small>
</div>

<form id="newbloodForm">
  <!-- ✅ چک‌باکس قرارداد -->
  <label style="display:flex;align-items:center;gap:8px">
    <input type="checkbox" id="contract_signed"> قرارداد امضا شده
  </label>

  <!-- ✅ استادیاران (چندتایی) -->
  <label>استادیاران</label>
  <div id="assistantsTags" style="display:flex;gap:6px;flex-wrap:wrap"></div>
  <div style="display:flex;gap:6px;align-items:center;margin-top:6px">
    <input type="text" id="assistantInput" placeholder="نام استادیار را بنویسید و + بزنید" style="flex:1">
    <button type="button" class="secondary" onclick="addAssistant()">+ افزودن</button>
  </div>
  <small class="muted">نکته: اولین استادیار به‌عنوان فیلد سازگاری «assistant» ذخیره می‌شود.</small>

  <div class="row">
    <div>
      <label>نام و نام خانوادگی</label>
      <input type="text" name="name" required>
    </div>
    <div>
      <label>موبایل</label>
      <input type="tel" name="mobile" required>
    </div>
  </div>

  <div class="row">
    <div>
      <label>اینستاگرام</label>
      <input type="text" name="instagram" placeholder="@username">
    </div>
    <div>
      <label>وضعیت تأهل</label>
      <select name="marital_status">
        <option value="">انتخاب کنید</option>
        <option value="single">مجرد</option>
        <option value="married">متأهل</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label>شغل اول</label>
      <input type="text" name="job1">
    </div>
    <div>
      <label>شغل دوم</label>
      <input type="text" name="job2">
    </div>
  </div>

  <label>سابقهٔ فعالیت ماساژ</label>
  <textarea name="massage_experience" placeholder="مختصر توضیح دهید..."></textarea>

  <label>مهارت‌هایی که به کار تیم سوان کمک می‌کند</label>
  <textarea name="skills" placeholder="مثلاً: عکاسی، تدوین، تدریس، مدیریت شبکه‌های اجتماعی و..."></textarea>

  <label>نحوهٔ آشنایی با خانوادهٔ سوان</label>
  <textarea name="how_met" placeholder="مثلاً: معرفی دوست، اینستاگرام، شرکت در رویداد و..."></textarea>

  <!-- علاقه‌مندی‌ها: سه تیک خواسته‌شده -->
  <label>علاقه‌مندی‌ها</label>
  <div class="row">
    <label><input type="checkbox" name="interests" value="anatomy"> آناتومی</label>
    <label><input type="checkbox" name="interests" value="ayurveda"> آیورودا</label>
    <label><input type="checkbox" name="interests" value="marketing"> بازاریابی</label>
  </div>

  <div class="row">
    <div>
      <label>تاریخ تولد (شمسی)</label>
      <input type="text" id="birthdate_j" class="pdate-input" placeholder="۱۴۰۴/۰۱/۱۵">
    </div>
    <div>
      <label>تاریخ دوره (شمسی)</label>
      <input type="text" id="course_date_j" class="pdate-input" placeholder="۱۴۰۴/۰۲/۲۰">
    </div>
  </div>

  <div class="row">
    <div>
      <label>محل دوره</label>
      <input type="text" name="course_location">
    </div>
    <div>
      <label>معرف / هماهنگ‌کننده</label>
      <input type="text" name="referrer">
    </div>
  </div>

  <div class="row">
    <div>
      <label>استان (Dropdown)</label>
      <select id="provinceSelect"></select>
      <!-- فیلد قبلی province حذف نمی‌شود؛ با انتخاب dropdown مقداردهی می‌شود. -->
      <input type="hidden" name="province" id="provinceHidden">
    </div>
    <div>
      <label>شهر</label>
      <input type="text" name="city">
    </div>
  </div>

  <!-- ✅ پیش‌پرداخت بالای اقساط -->
  <label>پیش‌پرداخت (تومان)</label>
  <input type="number" name="prepayment" min="0" step="1">

  <label>سطح رشد</label>
  <div class="stars" id="growthStars">
    <span data-val="1">★</span>
    <span data-val="2">★</span>
    <span data-val="3">★</span>
    <span data-val="4">★</span>
    <span data-val="5">★</span>
  </div>
  <input type="hidden" name="growth" id="growthVal" value="0">

  <!-- اقساط: فیلدهای جدید status + paidAmount + تیک اتمام -->
  <label>اقساط <span class="muted">(برای هر قسط می‌توانید فیش پرداختی آپلود کنید. با تیک «اتمام واریزی»، وضعیت همان قسط done می‌شود.)</span></label>
  <div class="installments" id="instContainer"></div>
  <button type="button" class="secondary" onclick="addInstallment()">+ افزودن قسط</button>

  <!-- سوان کوین -->
  <label>سوان کوین</label>
  <div class="coins-log" id="coinsContainer"></div>
  <button type="button" class="secondary" onclick="addCoin()">+ افزودن کوین</button>

  <!-- معرفی‌شده‌ها: فقط نام نیوبلادهای معرفی‌شده -->
  <label>نیوبلادهایی که معرفی کرده</label>
  <div class="referred" id="refContainer"></div>
  <button type="button" class="secondary" onclick="addReferred()">+ افزودن نام معرفی‌شده</button>

  <label>یادداشت</label>
  <textarea name="notes" placeholder="توضیحات تکمیلی..."></textarea>

  <div class="actions">
    <button type="submit" id="submitBtn">ثبت</button>
    <a class="secondary" href="/assistant" style="text-decoration:none;padding:.65rem 1.2rem;border-radius:10px;color:#fff">بازگشت به پنل استادیار</a>
  </div>

  <div id="msg" class="msg"></div>
</form>

<script>
  // ===== تنظیمات ادمین برای نمایش بکاپ و داشبورد =====
  const ADMIN_NAME  = "جواد مرتضوی";
  const ADMIN_EMAIL = "admin@swanfamily.app"; // به ایمیل ادمین خودت تغییر بده

  // ===== Backendless =====
  Backendless.initApp("8D939181-02F9-4505-92A9-57A80D713F65", "3EE7C64D-2CCD-4852-BFC3-F1949A4A73C8");

  // ===== استان‌ها (Dropdown) =====
  const IRAN_PROVINCES = [
    { code: "TEH", name: "تهران" },
    { code: "KHR", name: "خراسان رضوی" },
    { code: "ESF", name: "اصفهان" },
    { code: "FAR", name: "فارس" },
    { code: "ALB", name: "البرز" },
    { code: "MZN", name: "مازندران" },
    { code: "QOM", name: "قم" },
    { code: "GLN", name: "گیلان" },
    { code: "WAZ", name: "آذربایجان غربی" },
    { code: "EAZ", name: "آذربایجان شرقی" },
    { code: "KRH", name: "کرمانشاه" },
    { code: "KRM", name: "کرمان" },
    { code: "BKH", name: "خراسان جنوبی" },
    { code: "BKN", name: "خراسان شمالی" },
    { code: "YZD", name: "یزد" },
    { code: "SMN", name: "سمنان" },
    { code: "QAZ", name: "قزوین" },
    { code: "ZNJ", name: "زنجان" },
    { code: "HMD", name: "همدان" },
    { code: "LRS", name: "لرستان" },
    { code: "CHB", name: "چهارمحال و بختیاری" },
    { code: "KBD", name: "کهگیلویه و بویراحمد" },
    { code: "BHR", name: "بوشهر" },
    { code: "HRM", name: "هرمزگان" },
    { code: "ILM", name: "ایلام" },
    { code: "MKZ", name: "مرکزی" },
    { code: "KRD", name: "کردستان" },
    { code: "GZN", name: "گلستان" },
    { code: "ARW", name: "اردبیل" },
    { code: "SBN", name: "سیستان و بلوچستان" },
    { code: "KHU", name: "خوزستان" }
  ];

  function seedProvinceDropdown(){
    const sel = document.getElementById('provinceSelect');
    sel.innerHTML = '<option value="">انتخاب استان</option>' + IRAN_PROVINCES.map(p=>`<option value="${p.code}">${p.name}</option>`).join('');
    sel.onchange = ()=>{
      const code = sel.value;
      const found = IRAN_PROVINCES.find(p=>p.code===code);
      document.getElementById('provinceHidden').value = found ? found.name : '';
    };
  }
  seedProvinceDropdown();

  // نمایش نوار بکاپ و پنل ادمین فقط اگر ادمین لاگین باشد
  (async function showAdminBits(){
    try{
      const u = await Backendless.UserService.getCurrentUser();
      const isAdmin = !!u && ((u.name||"")===ADMIN_NAME || (u.email||"")===ADMIN_EMAIL);
      if(isAdmin){
        document.getElementById('backupBar').style.display = 'flex';
        document.getElementById('adminPanel').style.display = 'block';
        // پر کردن استان‌های فیلتر پنل ادمین
        const fSel = document.getElementById('filterProvince');
        IRAN_PROVINCES.forEach(p=>{
          const opt=document.createElement('option'); opt.value=p.name; opt.textContent=p.name; fSel.appendChild(opt);
        });
      }
    }catch(_){}}
  )();

  // ===== Persian datepickers =====
  $('#birthdate_j').persianDatepicker({ format:'YYYY/MM/DD', autoClose:true });
  $('#course_date_j').persianDatepicker({ format:'YYYY/MM/DD', autoClose:true });
  $('#filterFromJ').persianDatepicker({ format:'YYYY/MM/DD', autoClose:true });
  $('#filterToJ').persianDatepicker({ format:'YYYY/MM/DD', autoClose:true });

  // ===== Growth stars =====
  (function initStars(){
    const stars = document.querySelectorAll('#growthStars span');
    const out = document.getElementById('growthVal');
    stars.forEach(s=>{
      s.onclick=()=>{
        const v = +s.dataset.val;
        out.value = v;
        stars.forEach((el,i)=> el.classList.toggle('selected', i < v));
      };
    });
  })();

  // ===== Assistants (multi) =====
  let assistantsSet = new Set();
  function renderAssistantTags(){
    const box = document.getElementById('assistantsTags');
    box.innerHTML = '';
    assistantsSet.forEach(name=>{
      const tag = document.createElement('span');
      tag.innerHTML = `${name} <button type="button" onclick="removeAssistant('${name}')" style="background:#c8e6c9;border:none;border-radius:8px;padding:0 6px;cursor:pointer">×</button>`;
      box.appendChild(tag);
    });
  }
  function addAssistant(nameOpt){
    const inp = document.getElementById('assistantInput');
    const name = (nameOpt || inp.value || '').trim();
    if(!name) return;
    assistantsSet.add(name);
    inp.value = '';
    renderAssistantTags();
  }
  function removeAssistant(name){ assistantsSet.delete(name); renderAssistantTags(); }
  (function seedAssistantFromURL(){
    const a = new URLSearchParams(location.search).get('assistant');
    if(a){ addAssistant(decodeURIComponent(a).replace(/_/g,' ').trim()); }
  })();

  // ===== Helpers =====
  function jalaliStrToDate(str){
    if(!str) return null;
    const m = String(str).trim().match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if(!m) return null;
    const jy=+m[1], jm=+m[2], jd=+m[3];
    const g = window.jalaali.toGregorian(jy, jm, jd);
    return new Date(g.gy, g.gm-1, g.gd);
  }
  function toJalaliStr(d){
    if(!d) return '';
    const date = new Date(d);
    if(isNaN(date)) return '';
    const g={gy:date.getFullYear(), gm:date.getMonth()+1, gd:date.getDate()};
    const j= jalaali.toJalaali(g.gy,g.gm,g.gd);
    return `${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
  }
  const toNumber = v => (v===''||v==null ? null : Number(v));

  async function uploadReceipt(file){
    const safe = (file.name||'receipt').replace(/\s+/g,'_');
    const fname = `${Date.now()}_${safe}`;
    const res = await Backendless.Files.upload(file, `receipts/${fname}`, true);
    return res?.fileURL || res?.url || (typeof res === 'string' ? res : null);
  }

  // ===== KPI محاسبه آنی در فرم =====
  function refreshKPI(){
    try{
      const coins = Array.from(document.querySelectorAll('.coin-entry')).length;
      const instRows = Array.from(document.querySelectorAll('.installment'));
      let paid = 0, total = 0;
      instRows.forEach(row=>{
        const amount = toNumber($(row).find('.inst-amount').val())||0;
        total += amount;
        const status = $(row).find('.inst-done')[0]?.checked ? 'done' : 'pending';
        const paidAmount = status==='done' ? amount : (toNumber($(row).find('.inst-paid').val())||0);
        paid += paidAmount;
      });
      const remain = Math.max(total - paid, 0);
      document.getElementById('kpiCoins').textContent = coins;
      document.getElementById('kpiInstCount').textContent = instRows.length;
      document.getElementById('kpiPaid').textContent = paid.toLocaleString('fa-IR');
      document.getElementById('kpiRemain').textContent = remain.toLocaleString('fa-IR');
      document.getElementById('kpiPanel').style.display = 'grid';
    }catch(_){}
  }

  // ===== Dynamic rows =====
  function addInstallment(rowData){
    const div=document.createElement('div');
    div.className='installment';
    div.innerHTML=`
      <input type=\"text\" class=\"pdate-input inst-date\" placeholder=\"تاریخ قسط (شمسی)\">
      <input type=\"number\" class=\"inst-amount\" placeholder=\"مبلغ (تومان)\">
      <div>
        <input type=\"file\" class=\"inst-file\" accept=\"image/*,application/pdf\">
        <div class=\"muted curr-link\" style=\"margin-top:4px\"></div>
      </div>
      <label style=\"display:flex;align-items:center;gap:6px\"><input type=\"checkbox\" class=\"inst-done\"> اتمام واریزی</label>
      <div><input type=\"number\" class=\"inst-paid\" placeholder=\"پرداخت‌شده (تومان)\"></div>
      <button type=\"button\" onclick=\"this.parentNode.remove(); refreshKPI()\">حذف</button>`;
    document.getElementById('instContainer').appendChild(div);
    const dp = $(div.querySelector('.inst-date')).persianDatepicker({format:'YYYY/MM/DD',autoClose:true});

    // رویدادها برای KPI
    $(div).on('input change', 'input', refreshKPI);

    if(rowData){
      if(rowData.date) $(div).find('.inst-date').val(toJalaliStr(rowData.date));
      if(rowData.amount!=null) $(div).find('.inst-amount').val(rowData.amount);
      if(rowData.paidAmount!=null) $(div).find('.inst-paid').val(rowData.paidAmount);
      if(rowData.status==='done') $(div).find('.inst-done')[0].checked = true;
      if(rowData.receipt_url){
        div.dataset.currentUrl = rowData.receipt_url;
        div.querySelector('.curr-link').innerHTML = `<a href=\"${rowData.receipt_url}\" target=\"_blank\">مشاهده فیش فعلی</a>`;
      }
    }
    refreshKPI();
  }

  function addCoin(rowData){
    const div=document.createElement('div');
    div.className='coin-entry';
    div.innerHTML=`
      <input type=\"text\" class=\"pdate-input coin-date\" placeholder=\"تاریخ کوین (شمسی)\">
      <input type=\"text\" class=\"coin-note\" placeholder=\"توضیح (اختیاری)\">
      <button type=\"button\" onclick=\"this.parentNode.remove(); refreshKPI()\">حذف</button>`;
    document.getElementById('coinsContainer').appendChild(div);
    $(div.querySelector('.coin-date')).persianDatepicker({format:'YYYY/MM/DD',autoClose:true});
    $(div).on('input change', 'input', refreshKPI);
    if(rowData){
      if(rowData.date) $(div).find('.coin-date').val(toJalaliStr(rowData.date));
      if(rowData.note) $(div).find('.coin-note').val(rowData.note);
    }
    refreshKPI();
  }

  function addReferred(nameVal){
    const div=document.createElement('div');
    div.className='referred-entry';
    div.innerHTML=`
      <input type=\"text\" class=\"ref-name\" placeholder=\"نام نیوبلاد معرفی‌شده\">
      <button type=\"button\" onclick=\"this.parentNode.remove()\">حذف</button>`;
    document.getElementById('refContainer').appendChild(div);
    if(nameVal) $(div).find('.ref-name').val(nameVal);
  }

  // ===== حالت ویرایش: بارگذاری داده موجود =====
  let currentObjectId = new URLSearchParams(location.search).get('objectId') || null;
  if(currentObjectId){
    (async function loadExisting(){
      try{
        const rec = await Backendless.Data.of('Newbloods').findById(currentObjectId);

        document.getElementById('contract_signed').checked = !!rec.contract_signed;

        const list = (Array.isArray(rec.assistants) && rec.assistants.length)
          ? rec.assistants : (rec.assistant ? [rec.assistant] : []);
        assistantsSet = new Set(list); renderAssistantTags();

        document.querySelector('[name="name"]').value = rec.name||'';
        document.querySelector('[name="mobile"]').value = rec.mobile||'';
        document.querySelector('[name="instagram"]').value = rec.instagram||'';
        document.querySelector('[name="marital_status"]').value = rec.marital_status||'';
        document.querySelector('[name="job1"]').value = rec.job1||'';
        document.querySelector('[name="job2"]').value = rec.job2||'';
        document.querySelector('[name="massage_experience"]').value = rec.massage_experience||'';
        document.querySelector('[name="skills"]').value = rec.skills||'';
        document.querySelector('[name="how_met"]').value = rec.how_met||'';
        $('#birthdate_j').val(toJalaliStr(rec.birthdate));
        $('#course_date_j').val(toJalaliStr(rec.course_date));
        document.querySelector('[name="course_location"]').value = rec.course_location||'';
        document.querySelector('[name="referrer"]').value = rec.referrer||'';
        // استان: اگر مقدار متنی قبلی داشتیم، در dropdown معادلش را انتخاب کنیم
        const provName = rec.province||'';
        document.getElementById('provinceHidden').value = provName;
        const found = IRAN_PROVINCES.find(p=>p.name===provName);
        if(found){ document.getElementById('provinceSelect').value = found.code; }
        document.querySelector('[name="city"]').value = rec.city||'';
        document.querySelector('[name="prepayment"]').value = rec.prepayment||'';

        const gv = +rec.growth||0;
        document.getElementById('growthVal').value = gv;
        document.querySelectorAll('#growthStars span').forEach((s,i)=> s.classList.toggle('selected', i < gv));

        (Array.isArray(rec.instalments) ? rec.instalments : []).forEach(addInstallment);
        (Array.isArray(rec.coins) ? rec.coins : []).forEach(addCoin);
        (Array.isArray(rec.referred_people) ? rec.referred_people : []).forEach(addReferred);

        const ints = Array.isArray(rec.interests) ? rec.interests : [];
        ints.forEach(v=>{ const el = document.querySelector(`input[name="interests"][value="${v}"]`); if(el) el.checked = true; });

        refreshKPI();
      }catch(e){ console.error(e); alert('خطا در بارگذاری رکورد: ' + (e.message||e)); }
    })();
    document.getElementById('submitBtn').textContent = 'به‌روزرسانی';
  }

  // ===== Submit =====
  document.getElementById('newbloodForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const msg = document.getElementById('msg');
    msg.style.display='block'; msg.className='msg'; msg.textContent='در حال ذخیره...';

    const fd = new FormData(e.target);
    const data = {}; fd.forEach((v,k)=> data[k]=v);

    data.contract_signed = document.getElementById('contract_signed').checked;
    data.birthdate   = jalaliStrToDate($('#birthdate_j').val());
    data.course_date = jalaliStrToDate($('#course_date_j').val());
    data.growth = toNumber(document.getElementById('growthVal').value) || 0;
    data.prepayment = toNumber(data.prepayment);
    data.interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(i=>i.value);
    data.assistants = Array.from(assistantsSet);
    data.assistant  = data.assistants[0] || '';

    // اقساط (با فیلدهای جدید: status, paidAmount)
    const instRows = Array.from(document.querySelectorAll('.installment'));
    const instPromises = instRows.map(async row=>{
      const date = jalaliStrToDate($(row).find('.inst-date').val());
      const amount = toNumber($(row).find('.inst-amount').val());
      const paidAmountField = toNumber($(row).find('.inst-paid').val())||0;
      const done = $(row).find('.inst-done')[0]?.checked;
      const status = done ? 'done' : (paidAmountField>0 ? 'partial' : 'pending');
      const file = row.querySelector('.inst-file')?.files?.[0];
      let receipt_url = row.dataset.currentUrl || null;
      if(file){ try{ receipt_url = await uploadReceipt(file); }catch(e){ console.warn('upload failed',e); } }
      const paidAmount = done ? (amount||0) : paidAmountField;
      return (date || amount || receipt_url || paidAmount>0) ? { date, amount, paidAmount, status, receipt_url } : null;
    });
    data.instalments = (await Promise.all(instPromises)).filter(Boolean);

    // کوین‌ها
    data.coins = Array.from(document.querySelectorAll('.coin-entry')).map(row=>{
      const date = jalaliStrToDate($(row).find('.coin-date').val());
      const note = ($(row).find('.coin-note').val()||'').trim();
      return date ? { date, note } : null;
    }).filter(Boolean);

    // معرفی‌شده‌ها
    data.referred_people = Array.from(document.querySelectorAll('.ref-name')).map(i=>i.value.trim()).filter(Boolean);

    // وضعیت کلی پلن: اگر تمام اقساط done باشند
    const allDone = Array.isArray(data.instalments) && data.instalments.length>0 && data.instalments.every(x=>x.status==='done');
    data.isCompleted = !!allDone;
    data.completedAt = allDone ? new Date() : null;

    try{
      if(currentObjectId){ data.objectId = currentObjectId; }
      const saved = await Backendless.Data.of('Newbloods').save(data);
      msg.className='msg ok'; msg.textContent = currentObjectId ? '✅ اطلاعات به‌روزرسانی شد.' : '✅ اطلاعات ذخیره شد.';

      // NEW: به‌روزرسانی آمار تجمیعی استادیار (AssistantAggregates)
      try{ await recomputeAssistantAggregate(data.assistant); }catch(ex){ console.warn('aggregate failed', ex); }

      if(!currentObjectId){
        e.target.reset();
        $('#birthdate_j').val(''); $('#course_date_j').val('');
        document.getElementById('instContainer').innerHTML='';
        document.getElementById('coinsContainer').innerHTML='';
        document.getElementById('refContainer').innerHTML='';
        document.querySelectorAll('#growthStars span').forEach(s=>s.classList.remove('selected'));
        document.getElementById('growthVal').value=0;
        assistantsSet = new Set(); renderAssistantTags();
        refreshKPI();
      }
    }catch(err){ console.error(err); msg.className='msg err'; msg.textContent='❌ خطا در ذخیره: ' + (err.message||err); }
  });

  // ===== Aggregate per Assistant (Client-side Job + Table: AssistantAggregates) =====
  async function recomputeAssistantAggregate(assistantName){
    if(!assistantName) return;
    // همه رکوردهای نیوبلاد مربوط به این استادیار
    const tb = Backendless.Data.of('Newbloods');
    const where = `assistant = '${assistantName.replace(/'/g, "''")}'`;
    const qb = Backendless.DataQueryBuilder.create().setWhereClause(where).setPageSize(100);
    const all = []; let page=0, chunk=[];
    do{ qb.setOffset(page*100); chunk = await tb.find(qb); all.push(...chunk); page++; }while(chunk.length===100);

    let totalContracts=0,totalInstallments=0,totalAmount=0,totalPaid=0,openNewbloods=0;
    for(const rec of all){
      totalContracts += 1;
      const inst = Array.isArray(rec.instalments)? rec.instalments : [];
      let planPaid=0; let planTotal=0; let allDone=true;
      for(const ins of inst){
        totalInstallments += 1;
        planTotal += +ins.amount||0;
        planPaid  += +ins.paidAmount||0;
        if(ins.status !== 'done') allDone=false;
      }
      totalAmount += planTotal;
      totalPaid   += planPaid;
      if(!allDone) openNewbloods += 1;
    }
    const totalRemaining = Math.max(totalAmount - totalPaid, 0);

    // خواندن swanCoins از مجموع کوین‌های همین استادیار (اختیاری)
    let swanCoins = 0;
    for(const rec of all){ swanCoins += Array.isArray(rec.coins)? rec.coins.length : 0; }

    const payload = {
      assistant: assistantName,
      totalContracts,
      totalInstallments,
      totalAmount,
      totalPaid,
      totalRemaining,
      openNewbloods,
      swanCoins,
      updatedAt: new Date()
    };
    // upsert در جدول AssistantAggregates
    const aggTB = Backendless.Data.of('AssistantAggregates');
    const qb2 = Backendless.DataQueryBuilder.create().setWhereClause(`assistant='${assistantName.replace(/'/g, "''")}'`).setPageSize(1);
    const ex = await aggTB.find(qb2);
    if(ex && ex[0]){ payload.objectId = ex[0].objectId; }
    await aggTB.save(payload);
  }

  // ====== بکاپ دستی: JSON & CSV (فقط ادمین) ======
  async function fetchAllNewbloods(){
    const store = [];
    let page = 0, pageSize = 100, chunk = [];
    const tb = Backendless.Data.of('Newbloods');
    do{
      const qb = Backendless.DataQueryBuilder.create().setPageSize(pageSize).setOffset(page*pageSize).setSortBy(['created DESC']);
      chunk = await tb.find(qb); store.push(...chunk); page++;
    }while(chunk.length === pageSize);
    return store;
  }

  function download(filename, text, mime='application/json'){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
  }

  async function backupJSON(){ try{ const data = await fetchAllNewbloods(); const fname = `swanfamily_newbloods_${new Date().toISOString().slice(0,10)}.json`; download(fname, JSON.stringify(data, null, 2), 'application/json'); }catch(e){ alert('خطا در بکاپ JSON'); console.error(e); } }

  function toCSV(arr){ if(!arr.length) return ''; const cols = [...new Set(arr.flatMap(o=>Object.keys(o)))]; const esc = v => { if(v==null) return ''; const s = typeof v === 'object' ? JSON.stringify(v) : String(v); return `"${s.replace(/"/g,'""')}"`; }; const head = cols.map(esc).join(','); const rows = arr.map(o=> cols.map(c=>esc(o[c])).join(',')).join('\n'); return head + '\n' + rows; }
  async function backupCSV(){ try{ const data = await fetchAllNewbloods(); const fname = `swanfamily_newbloods_${new Date().toISOString().slice(0,10)}.csv`; download(fname, toCSV(data), 'text/csv;charset=utf-8'); }catch(e){ alert('خطا در بکاپ CSV'); console.error(e); } }

  // ===== Admin Report (Monthly + Filters) =====
  function toISODate(jstr){ const d = jalaliStrToDate(jstr); return d ? d.toISOString() : null; }

  async function runAdminReport(){
    const prov = document.getElementById('filterProvince').value.trim();
    const assistant = document.getElementById('filterAssistant').value.trim();
    const fromISO = toISODate($('#filterFromJ').val());
    const toISO   = toISODate($('#filterToJ').val());

    let whereParts = [];
    if(prov) whereParts.push(`province='${prov.replace(/'/g,"''")}'`);
    if(assistant) whereParts.push(`assistant='${assistant.replace(/'/g,"''")}'`);
    if(fromISO) whereParts.push(`created >= '${fromISO}'`);
    if(toISO)   whereParts.push(`created <= '${toISO}'`);

    const tb = Backendless.Data.of('Newbloods');
    const qb = Backendless.DataQueryBuilder.create().setPageSize(200).setWhereClause(whereParts.join(' AND ')).setSortBy(['created DESC']);
    const rows = await tb.find(qb);

    // ساخت جدول ماهانه
    const byMonth = new Map();
    function ym(d){ const dt=new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; }

    for(const r of rows){
      const inst = Array.isArray(r.instalments)? r.instalments : [];
      for(const ins of inst){
        const key = ins.date ? ym(ins.date) : (r.created? ym(r.created):'unknown');
        if(!byMonth.has(key)) byMonth.set(key,{ month:key, total:0, paid:0, count:0, done:0, pending:0 });
        const bucket = byMonth.get(key);
        const amt= +ins.amount||0; const pad= +ins.paidAmount||0; const st=ins.status||'pending';
        bucket.total += amt; bucket.paid += pad; bucket.count += 1; if(st==='done') bucket.done+=1; else bucket.pending+=1;
      }
    }

    const arr = [...byMonth.values()].sort((a,b)=> a.month.localeCompare(b.month));

    // رندر جدول
    const wrap = document.getElementById('adminTableWrap');
    if(!arr.length){ wrap.innerHTML = '<p class="muted">داده‌ای یافت نشد.</p>'; return; }
    let html = '<table class="table"><thead><tr><th>ماه</th><th>تعداد اقساط</th><th>تمام‌شده</th><th>باز</th><th>مجموع مبلغ</th><th>پرداخت‌شده</th><th>باقی‌مانده</th></tr></thead><tbody>';
    arr.forEach(r=>{
      const remain = Math.max(r.total - r.paid, 0);
      html += `<tr><td>${r.month}</td><td>${r.count}</td><td>${r.done}</td><td>${r.pending}</td><td>${r.total.toLocaleString('fa-IR')}</td><td>${r.paid.toLocaleString('fa-IR')}</td><td>${remain.toLocaleString('fa-IR')}</td></tr>`;
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;

    // ذخیره آخرین نتیجه برای خروجی CSV
    window.__lastAdminReport = arr;
  }

  document.getElementById('btnRunReport')?.addEventListener('click', runAdminReport);
  document.getElementById('btnExportReport')?.addEventListener('click', ()=>{
    const arr = window.__lastAdminReport || [];
    if(!arr.length){ alert('اول گزارش را اجرا کن.'); return; }
    const csv = toCSV(arr);
    const fname = `swan_admin_report_${new Date().toISOString().slice(0,10)}.csv`;
    download(fname, csv, 'text/csv;charset=utf-8');
  });
</script>

</body>
</html>
